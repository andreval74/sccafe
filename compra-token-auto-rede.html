<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra de Tokens - Auto Rede</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .network-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        .total {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ü™ô Comprar Tokens</h2>
        
        <div id="networkInfo" class="network-info">
            üîç Detectando rede...
        </div>
        
        <div class="form-group">
            <label for="quantidade">Quantidade de Tokens:</label>
            <input type="number" id="quantidade" placeholder="Ex: 100" min="1" step="1">
        </div>
        
        <div class="form-group">
            <label for="preco">Pre√ßo por Token (BNB):</label>
            <input type="number" id="preco" placeholder="0.001" step="0.000001" readonly>
        </div>
        
        <div class="total">
            Total: <span id="totalBNB">0</span> BNB
        </div>
        
        <button id="conectarBtn" onclick="iniciarConexao()">Conectar & Configurar</button>
        <button id="comprarBtn" onclick="comprarTokens()" disabled>Comprar Tokens</button>
        
        <div id="status" class="status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        // Configura√ß√µes das redes
        const REDES = {
            // BSC Mainnet
            56: {
                nome: 'BSC Mainnet',
                chainId: 56,
                rpcUrl: 'https://bsc-dataseed.binance.org/',
                explorerUrl: 'https://bscscan.com',
                contractAddress: '0x43d9389C0eb6d01Ed04d01244a63E634bc8889d4', // Substitua pelo endere√ßo real
                tokenPrice: 0.001
            },
            // BSC Testnet
            97: {
                nome: 'BSC Testnet',
                chainId: 97,
                rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545/',
                explorerUrl: 'https://testnet.bscscan.com',
                contractAddress: '0x43d9389C0eb6d01Ed04d01244a63E634bc8889d4',
                tokenPrice: 0.001
            }
        };
        
        // Rede preferencial (mude para 56 para mainnet)
        const REDE_PREFERENCIAL = 97;
        
        let web3;
        let userAccount;
        let contract;
        let redeAtual;
        
        // ABI m√≠nima para compra de tokens
        const contractABI = [
            {
                "inputs": [],
                "name": "buyTokens",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
                "name": "buy",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "tokenPrice",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        // Inicializar
        window.addEventListener('load', function() {
            document.getElementById('quantidade').addEventListener('input', calcularTotal);
            detectarRedeAtual();
            
            // Verificar se MetaMask est√° instalado
            if (typeof window.ethereum === 'undefined') {
                mostrarStatus('‚ùå MetaMask n√£o encontrado! Instale a extens√£o.', 'error');
                return;
            }
            
            // Escutar mudan√ßas de rede
            window.ethereum.on('chainChanged', (chainId) => {
                const novaRede = parseInt(chainId, 16);
                atualizarInfoRede(novaRede);
            });
        });
        
        async function detectarRedeAtual() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const redeId = parseInt(chainId, 16);
                    atualizarInfoRede(redeId);
                } else {
                    document.getElementById('networkInfo').textContent = '‚ùå MetaMask n√£o detectado';
                }
            } catch (error) {
                document.getElementById('networkInfo').textContent = '‚ö†Ô∏è Erro ao detectar rede';
            }
        }
        
        function atualizarInfoRede(chainId) {
            redeAtual = chainId;
            const rede = REDES[chainId];
            const networkInfo = document.getElementById('networkInfo');
            
            if (rede) {
                networkInfo.innerHTML = `üåê Conectado: <strong>${rede.nome}</strong>`;
                document.getElementById('preco').value = rede.tokenPrice;
                calcularTotal();
                
                if (chainId === REDE_PREFERENCIAL) {
                    networkInfo.style.background = '#d4edda';
                    networkInfo.style.color = '#155724';
                } else {
                    networkInfo.style.background = '#fff3cd';
                    networkInfo.style.color = '#856404';
                    networkInfo.innerHTML += ` (ser√° trocada para ${REDES[REDE_PREFERENCIAL].nome})`;
                }
            } else {
                networkInfo.innerHTML = `‚ö†Ô∏è Rede n√£o suportada (ID: ${chainId})`;
                networkInfo.style.background = '#f8d7da';
                networkInfo.style.color = '#721c24';
            }
        }
        
        function calcularTotal() {
            const quantidade = parseFloat(document.getElementById('quantidade').value) || 0;
            const preco = parseFloat(document.getElementById('preco').value) || 0;
            const total = quantidade * preco;
            document.getElementById('totalBNB').textContent = total.toFixed(6);
        }
        
        async function iniciarConexao() {
            try {
                mostrarStatus('üîÑ Conectando...', 'info');
                
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask n√£o encontrado!');
                }
                
                // Solicitar conex√£o
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    throw new Error('Nenhuma conta selecionada');
                }
                
                userAccount = accounts[0];
                web3 = new Web3(window.ethereum);
                
                // Verificar e configurar rede
                await configurarRede();
                
                // Criar inst√¢ncia do contrato
                const redeConfig = REDES[REDE_PREFERENCIAL];
                contract = new web3.eth.Contract(contractABI, redeConfig.contractAddress);
                
                // Atualizar interface
                document.getElementById('conectarBtn').style.display = 'none';
                document.getElementById('comprarBtn').disabled = false;
                
                mostrarStatus(`‚úÖ Conectado: ${userAccount.substring(0,6)}...${userAccount.substring(38)}`, 'success');
                
            } catch (error) {
                console.error('Erro ao conectar:', error);
                mostrarStatus('‚ùå Erro ao conectar: ' + error.message, 'error');
            }
        }
        
        async function configurarRede() {
            try {
                const chainId = await web3.eth.getChainId();
                
                if (chainId === REDE_PREFERENCIAL) {
                    mostrarStatus(`‚úÖ J√° conectado na ${REDES[REDE_PREFERENCIAL].nome}`, 'success');
                    return;
                }
                
                mostrarStatus(`üîÑ Trocando para ${REDES[REDE_PREFERENCIAL].nome}...`, 'info');
                
                const redeConfig = REDES[REDE_PREFERENCIAL];
                
                try {
                    // Tentar trocar para a rede
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x' + redeConfig.chainId.toString(16) }]
                    });
                    
                    mostrarStatus(`‚úÖ Trocado para ${redeConfig.nome}`, 'success');
                    
                } catch (switchError) {
                    // Se a rede n√£o existe, adicionar
                    if (switchError.code === 4902) {
                        mostrarStatus(`‚ûï Adicionando ${redeConfig.nome}...`, 'info');
                        
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x' + redeConfig.chainId.toString(16),
                                chainName: redeConfig.nome,
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: [redeConfig.rpcUrl],
                                blockExplorerUrls: [redeConfig.explorerUrl]
                            }]
                        });
                        
                        mostrarStatus(`‚úÖ ${redeConfig.nome} adicionada e conectada`, 'success');
                    } else {
                        throw switchError;
                    }
                }
                
            } catch (error) {
                throw new Error('Erro ao configurar rede: ' + error.message);
            }
        }
        
        async function comprarTokens() {
            try {
                const quantidade = parseFloat(document.getElementById('quantidade').value);
                const redeConfig = REDES[REDE_PREFERENCIAL];
                const total = quantidade * redeConfig.tokenPrice;
                
                if (!quantidade || quantidade <= 0) {
                    throw new Error('Digite uma quantidade v√°lida');
                }
                
                if (!userAccount) {
                    throw new Error('Conecte sua carteira primeiro');
                }
                
                mostrarStatus('üîÑ Processando compra...', 'info');
                document.getElementById('comprarBtn').disabled = true;
                
                // Verificar saldo
                const saldo = await web3.eth.getBalance(userAccount);
                const saldoBNB = web3.utils.fromWei(saldo, 'ether');
                
                if (parseFloat(saldoBNB) < total) {
                    throw new Error(`üí∞ Saldo insuficiente. Voc√™ tem ${parseFloat(saldoBNB).toFixed(4)} BNB`);
                }
                
                // Tentar diferentes m√©todos de compra
                let transactionHash;
                try {
                    // M√©todo 1: buyTokens()
                    const tx = await contract.methods.buyTokens().send({
                        from: userAccount,
                        value: web3.utils.toWei(total.toString(), 'ether'),
                        gas: 300000
                    });
                    transactionHash = tx.transactionHash;
                } catch (error1) {
                    try {
                        // M√©todo 2: buy(amount)
                        const tx = await contract.methods.buy(quantidade).send({
                            from: userAccount,
                            value: web3.utils.toWei(total.toString(), 'ether'),
                            gas: 300000
                        });
                        transactionHash = tx.transactionHash;
                    } catch (error2) {
                        // M√©todo 3: Transa√ß√£o direta
                        const tx = await web3.eth.sendTransaction({
                            from: userAccount,
                            to: redeConfig.contractAddress,
                            value: web3.utils.toWei(total.toString(), 'ether'),
                            gas: 300000
                        });
                        transactionHash = tx.transactionHash;
                    }
                }
                
                mostrarStatus(`üéâ Compra realizada! TX: ${transactionHash.substring(0,10)}...`, 'success');
                
                // Limpar formul√°rio
                document.getElementById('quantidade').value = '';
                calcularTotal();
                
            } catch (error) {
                console.error('Erro na compra:', error);
                mostrarStatus('‚ùå Erro na compra: ' + error.message, 'error');
            } finally {
                document.getElementById('comprarBtn').disabled = false;
            }
        }
        
        function mostrarStatus(mensagem, tipo) {
            const status = document.getElementById('status');
            status.textContent = mensagem;
            status.className = `status ${tipo}`;
            status.style.display = 'block';
            
            if (tipo === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>