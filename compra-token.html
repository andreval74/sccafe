<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compra de Tokens - SCCAFE</title>
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="imgs/sccafe-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="imgs/sccafe-32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="imgs/sccafe-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="imgs/sccafe-512x512.png">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- SCCAFE Global CSS Unificado -->
  <link href="styles/globals.css" rel="stylesheet">
  
  <!-- Meta tags SEO -->
  <meta name="description" content="Compre tokens diretamente via MetaMask com os melhores pre√ßos do mercado. Suporte para Ethereum, BSC, Polygon e outras redes.">
  <meta name="keywords" content="comprar token, metamask, pancakeswap, uniswap, DEX, swap, SCCAFE">
</head>
<body>
  <!-- Header -->
  <header data-component="header"></header>
  
  <!-- Main Content -->
  <main class="token-purchase-main py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
          <!-- Page Header -->
          <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-white mb-3">
              <i class="bi bi-cart-check text-primary me-3"></i>Compra de Tokens
            </h1>
            <p class="lead text-secondary">
              Compre tokens diretamente via MetaMask com os melhores pre√ßos das principais DEXs
            </p>
          </div>
          
          <!-- Purchase Card -->
          <div class="card bg-dark border-primary shadow-lg">
            <!-- Connection Status -->
            <div class="card-header bg-primary text-dark">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-wallet2 me-2"></i>Status da Conex√£o
                </h5>
                <button id="connectBtn" class="btn btn-dark btn-sm">
                  <i class="bi bi-link-45deg me-1"></i>Conectar MetaMask
                </button>
              </div>
            </div>

            
            <div class="card-body p-4">
              <!-- Connection Status Display -->
              <div class="connection-status mb-4">
                <div class="alert alert-info d-flex align-items-center" id="connectionAlert">
                  <i class="bi bi-info-circle me-2"></i>
                  <span id="status">Detectando MetaMask...</span>
                </div>
                <div class="text-center">
                  <small class="text-muted">
                    N√£o tem MetaMask? 
                    <a href="https://metamask.io/" target="_blank" class="text-primary text-decoration-none fw-bold">
                      <i class="bi bi-download me-1"></i>Instalar aqui
                    </a>
                  </small>
                </div>
              </div>

              <!-- Purchase Form -->
              <form id="purchaseForm">
                <!-- Mode Selection -->
                <div class="mb-4">
                  <label class="form-label text-white">
                    <i class="bi bi-toggles text-primary me-2"></i>Modo de Compra
                  </label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="purchaseMode" id="mode-dex" value="dex" checked>
                    <label class="btn btn-outline-primary" for="mode-dex">
                      <i class="bi bi-graph-up me-1"></i>DEX (Token Listado)
                    </label>
                    
                    <input type="radio" class="btn-check" name="purchaseMode" id="mode-manual" value="manual">
                    <label class="btn btn-outline-primary" for="mode-manual">
                      <i class="bi bi-pencil me-1"></i>Manual (Meu Token)
                    </label>
                  </div>
                  <div class="form-text text-muted mt-2">
                    <strong>DEX:</strong> Busca pre√ßos autom√°ticos de tokens j√° listados em exchanges | 
                    <strong>Manual:</strong> ‚≠ê Para seus tokens - recebe pagamento e envia tokens automaticamente
                  </div>
                </div>

                <!-- Token Selection -->
                <div class="row g-4 mb-4">
                  <div class="col-md-8">
                    <label for="tokenAddress" class="form-label text-white">
                      <i class="bi bi-coin text-primary me-2"></i>Endere√ßo do Token (ERC-20/BEP-20)
                    </label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" 
                           id="tokenAddress" placeholder="0x..." required>
                    <div class="form-text text-muted">Endere√ßo do contrato do token que deseja comprar</div>
                  </div>
                  <div class="col-md-4">
                    <label for="network" class="form-label text-white">
                      <i class="bi bi-globe text-primary me-2"></i>Rede/DEX
                    </label>
                    <select class="form-control bg-dark text-white border-secondary" id="network">
                      <optgroup label="üî¥ MAINNETS (Real Money)">
                        <option value="1">Ethereum (Uniswap)</option>
                        <option value="56">BSC (PancakeSwap)</option>
                        <option value="137">Polygon (QuickSwap)</option>
                        <option value="43114">Avalanche (Trader Joe)</option>
                      </optgroup>
                      <optgroup label="üü° TESTNETS (Para Testes)">
                        <option value="11155111">Sepolia Testnet (tETH)</option>
                        <option value="97" selected>BSC Testnet (tBNB)</option>
                        <option value="80001">Mumbai Testnet (tMATIC)</option>
                        <option value="43113">Fuji Testnet (tAVAX)</option>
                      </optgroup>
                    </select>
                    <div class="form-text text-muted">Use testnets para testar sem gastar dinheiro real</div>
                  </div>
                </div>

                <!-- Receiver Address -->
                <div class="mb-4">
                  <label for="receiverAddress" class="form-label text-white">
                    <i class="bi bi-person-badge text-primary me-2"></i>Endere√ßo Recebedor
                  </label>
                  <input type="text" class="form-control bg-dark text-white border-secondary" 
                         id="receiverAddress" placeholder="0x..." required>
                  <div class="form-text text-muted">Endere√ßo que receber√° os tokens comprados (deixe vazio para usar sua carteira)</div>
                </div>

                <!-- DEX Mode Fields -->
                <div id="dex-mode-fields">
                  <div class="row g-4 mb-4">
                    <div class="col-md-6">
                      <label for="ethAmount" class="form-label text-white">
                        <i class="bi bi-currency-exchange text-primary me-2"></i>Valor em ETH/BNB/MATIC
                      </label>
                      <input type="number" class="form-control bg-dark text-white border-secondary" 
                             id="ethAmount" placeholder="0.1" step="0.001" min="0.001">
                      <div class="form-text text-muted">Quantidade de moeda nativa que deseja trocar</div>
                    </div>
                    <div class="col-md-6">
                      <label for="expectedTokens" class="form-label text-white">
                        <i class="bi bi-graph-up text-primary me-2"></i>Tokens Estimados
                      </label>
                      <input type="text" class="form-control bg-dark text-white border-secondary" 
                             id="expectedTokens" placeholder="Calculando..." readonly>
                      <div class="form-text text-muted">Quantidade estimada de tokens que receber√°</div>
                    </div>
                  </div>
                </div>

                <!-- Manual Mode Fields -->
                <div id="manual-mode-fields" style="display: none;">
                  <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Modo Manual:</strong> Voc√™ est√° definindo pre√ßo e quantidade manualmente. 
                    Certifique-se de que o endere√ßo recebedor √© o propriet√°rio do token ou tem autoriza√ß√£o para receb√™-lo.
                  </div>
                  
                  <div class="row g-4 mb-4">
                    <div class="col-md-4">
                      <label for="tokenPrice" class="form-label text-white">
                        <i class="bi bi-tag text-primary me-2"></i>Pre√ßo por Token
                      </label>
                      <div class="input-group">
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               id="tokenPrice" placeholder="0.001" step="0.0001" min="0.0001">
                        <span class="input-group-text bg-secondary text-white" id="nativeCoinLabel">ETH</span>
                      </div>
                      <div class="form-text text-muted">Pre√ßo que voc√™ est√° cobrando por cada token</div>
                    </div>
                    <div class="col-md-4">
                      <label for="tokenQuantity" class="form-label text-white">
                        <i class="bi bi-123 text-primary me-2"></i>Quantidade de Tokens
                      </label>
                      <input type="number" class="form-control bg-dark text-white border-secondary" 
                             id="tokenQuantity" placeholder="1000" step="1" min="1">
                      <div class="form-text text-muted">Quantos tokens o comprador receber√°</div>
                    </div>
                    <div class="col-md-4">
                      <label for="totalCost" class="form-label text-white">
                        <i class="bi bi-calculator text-primary me-2"></i>Total a Pagar
                      </label>
                      <div class="input-group">
                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                               id="totalCost" placeholder="0.000" readonly>
                        <span class="input-group-text bg-secondary text-white" id="totalCoinLabel">ETH</span>
                      </div>
                      <div class="form-text text-muted">Valor total que ser√° cobrado do comprador</div>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                  <button type="button" id="calculateBtn" class="btn btn-outline-primary btn-lg" disabled>
                    <i class="bi bi-calculator me-2"></i>
                    <span id="calculateBtnText">Calcular Pre√ßo DEX</span>
                  </button>
                  <button type="button" id="executeBtn" class="btn btn-primary btn-lg" disabled>
                    <i class="bi bi-cart-check me-2"></i>
                    <span id="executeBtnText">Executar Compra via DEX</span>
                  </button>
                  <button type="button" id="transferBtn" class="btn btn-success btn-lg" style="display: none;" disabled>
                    <i class="bi bi-send me-2"></i>Transferir Tokens (Modo Manual)
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Transaction Log -->
          <div class="card bg-dark border-secondary mt-4">
            <div class="card-header">
              <h5 class="mb-0 text-white">
                <i class="bi bi-journal-text text-primary me-2"></i>Log de Transa√ß√µes
              </h5>
            </div>
            <div class="card-body">
              <pre id="log" class="bg-black text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">Aguardando a√ß√£o do usu√°rio...</pre>
            </div>
          </div>

          <!-- Help Section -->
          <div class="card bg-secondary mt-4">
            <div class="card-body">
              <h6 class="text-white mb-3">
                <i class="bi bi-info-circle text-primary me-2"></i>Como Funciona & Como Testar
              </h6>
              
              <!-- Testnet Info -->
              <div class="alert alert-warning mb-3">
                <h6 class="alert-heading">üü° Para Testes Seguros (Recomendado)</h6>
                <p class="mb-2">Use <strong>BSC Testnet</strong> para testar sem gastar dinheiro real:</p>
                <ol class="mb-2">
                  <li>Conecte √† <strong>BSC Testnet</strong> no MetaMask</li>
                  <li>Obtenha <strong>tBNB gr√°tis</strong>: <a href="https://testnet.binance.org/faucet" target="_blank" class="text-primary">https://testnet.binance.org/faucet</a></li>
                  <li>Use o endere√ßo do seu token de teste</li>
                  <li>Teste √† vontade - n√£o custa nada real!</li>
                </ol>
              </div>
              
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="text-center">
                    <i class="bi bi-wallet2 text-primary" style="font-size: 2rem;"></i>
                    <h6 class="text-white mt-2">1. Conecte</h6>
                    <small class="text-muted">Conecte MetaMask √† rede desejada (use testnet para testes)</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center">
                    <i class="bi bi-toggles text-primary" style="font-size: 2rem;"></i>
                    <h6 class="text-white mt-2">2. Escolha Modo</h6>
                    <small class="text-muted"><strong>DEX:</strong> Tokens listados | <strong>Manual:</strong> Seus tokens</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center">
                    <i class="bi bi-arrow-left-right text-primary" style="font-size: 2rem;"></i>
                    <h6 class="text-white mt-2">3. Execute</h6>
                    <small class="text-muted">Modo manual: Recebe pagamento + envia tokens automaticamente</small>
                  </div>
                </div>
              </div>
              
              <!-- Faucets -->
              <div class="mt-3">
                <h6 class="text-white">üö∞ Faucets para Testes (Tokens Gr√°tis):</h6>
                <ul class="list-unstyled text-muted small">
                  <li>‚Ä¢ <strong>tBNB:</strong> <a href="https://testnet.binance.org/faucet" target="_blank" class="text-primary">BSC Testnet Faucet</a></li>
                  <li>‚Ä¢ <strong>tETH:</strong> <a href="https://faucets.chain.link/sepolia" target="_blank" class="text-primary">Chainlink Sepolia Faucet</a></li>
                  <li>‚Ä¢ <strong>tMATIC:</strong> <a href="https://faucet.polygon.technology/" target="_blank" class="text-primary">Polygon Mumbai Faucet</a></li>
                  <li>‚Ä¢ <strong>tAVAX:</strong> <a href="https://faucet.avax.network/" target="_blank" class="text-primary">Avalanche Fuji Faucet</a></li>
                </ul>
                
                <div class="alert alert-info mt-3">
                  <h6 class="alert-heading">üí° Dica: Teste com seu pr√≥prio token</h6>
                  <p class="mb-0">
                    1. V√° em <a href="add-index.html" class="text-primary"><strong>Criar Token</strong></a> e crie um token de teste na BSC Testnet<br>
                    2. Volte aqui e use o <strong>Modo Manual</strong> com o endere√ßo do seu token<br>
                    3. Teste comprando com tBNB - √© gr√°tis e funciona perfeitamente!
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer data-component="footer"></footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Template Loader -->
  <script src="js/template-loader.js"></script>

  <script>
    /**
     * SCCAFE Token Purchase System
     * Suporte para m√∫ltiplas DEXs: PancakeSwap, Uniswap, QuickSwap, Trader Joe
     */

    // Configura√ß√µes das DEXs por rede (incluindo testnets)
    const DEX_CONFIG = {
      1: { // Ethereum Mainnet
        name: 'Ethereum (Uniswap)',
        router: '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D',
        weth: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',
        dexName: 'Uniswap V2',
        nativeCoin: 'ETH',
        blockExplorer: 'https://etherscan.io',
        isTestnet: false
      },
      11155111: { // Ethereum Sepolia Testnet
        name: 'Sepolia Testnet (Uniswap)',
        router: '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D',
        weth: '0xfFf9976782d46CC05630D1f6eBAb18b2324d6B14', // WETH Sepolia
        dexName: 'Uniswap V2',
        nativeCoin: 'tETH',
        blockExplorer: 'https://sepolia.etherscan.io',
        isTestnet: true
      },
      56: { // BSC Mainnet
        name: 'BSC (PancakeSwap)',
        router: '0x10ED43C718714eb63d5aA57B78B54704E256024E',
        weth: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c', // WBNB
        dexName: 'PancakeSwap V2',
        nativeCoin: 'BNB',
        blockExplorer: 'https://bscscan.com',
        isTestnet: false
      },
      97: { // BSC Testnet
        name: 'BSC Testnet (PancakeSwap)',
        router: '0xD99D1c33F9fC3444f8101754aBC46c52416550D1',
        weth: '0xae13d989daC2f0dEbFf460aC112a837C89BAa7cd', // WBNB Testnet
        dexName: 'PancakeSwap V2',
        nativeCoin: 'tBNB',
        blockExplorer: 'https://testnet.bscscan.com',
        isTestnet: true
      },
      137: { // Polygon Mainnet
        name: 'Polygon (QuickSwap)',
        router: '0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff',
        weth: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270', // WMATIC
        dexName: 'QuickSwap',
        nativeCoin: 'MATIC',
        blockExplorer: 'https://polygonscan.com',
        isTestnet: false
      },
      80001: { // Polygon Mumbai Testnet
        name: 'Mumbai Testnet (QuickSwap)',
        router: '0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff',
        weth: '0x9c3C9283D3e44854697Cd22D3Faa240Cfb032889', // WMATIC Mumbai
        dexName: 'QuickSwap',
        nativeCoin: 'tMATIC',
        blockExplorer: 'https://mumbai.polygonscan.com',
        isTestnet: true
      },
      43114: { // Avalanche Mainnet
        name: 'Avalanche (Trader Joe)',
        router: '0x60aE616a2155Ee3d9A68541Ba4544862310933d4',
        weth: '0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7', // WAVAX
        dexName: 'Trader Joe',
        nativeCoin: 'AVAX',
        blockExplorer: 'https://snowtrace.io',
        isTestnet: false
      },
      43113: { // Avalanche Fuji Testnet
        name: 'Fuji Testnet (Trader Joe)',
        router: '0x2D99ABD9008Dc933ff5c0CD271B88309593aB921',
        weth: '0xd00ae08403B9bbb9124bB305C09058E32C39A48c', // WAVAX Fuji
        dexName: 'Trader Joe',
        nativeCoin: 'tAVAX',
        blockExplorer: 'https://testnet.snowtrace.io',
        isTestnet: true
      }
    };

    // Estado global
    let provider = null;
    let signer = null;
    let userAddress = null;
    let currentChainId = null;
    let currentConfig = null;
    let purchaseMode = 'dex'; // 'dex' ou 'manual'

    // Elementos da UI
    const ui = {
      status: document.getElementById('status'),
      connectBtn: document.getElementById('connectBtn'),
      calculateBtn: document.getElementById('calculateBtn'),
      executeBtn: document.getElementById('executeBtn'),
      transferBtn: document.getElementById('transferBtn'),
      connectionAlert: document.getElementById('connectionAlert'),
      
      // Mode elements
      modeDex: document.getElementById('mode-dex'),
      modeManual: document.getElementById('mode-manual'),
      dexModeFields: document.getElementById('dex-mode-fields'),
      manualModeFields: document.getElementById('manual-mode-fields'),
      calculateBtnText: document.getElementById('calculateBtnText'),
      executeBtnText: document.getElementById('executeBtnText'),
      nativeCoinLabel: document.getElementById('nativeCoinLabel'),
      totalCoinLabel: document.getElementById('totalCoinLabel'),
      
      tokenAddress: document.getElementById('tokenAddress'),
      receiverAddress: document.getElementById('receiverAddress'),
      ethAmount: document.getElementById('ethAmount'),
      expectedTokens: document.getElementById('expectedTokens'),
      network: document.getElementById('network'),
      
      // Manual mode fields
      tokenPrice: document.getElementById('tokenPrice'),
      tokenQuantity: document.getElementById('tokenQuantity'),
      totalCost: document.getElementById('totalCost'),
      
      log: document.getElementById('log')
    };

    // Fun√ß√µes utilit√°rias
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      ui.log.textContent = `[${timestamp}] ${icon} ${message}\n` + ui.log.textContent;
      console.log(`[SCCAFE Purchase] ${message}`);
    }

    function shortAddr(addr) {
      if (!addr) return '';
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

    function updateConnectionStatus(connected, chainId = null) {
      if (connected && userAddress) {
        const config = DEX_CONFIG[chainId] || { name: `Chain ${chainId}`, nativeCoin: 'ETH', isTestnet: false };
        
        // Indicador visual para testnet
        const networkIndicator = config.isTestnet ? 'üü° TESTNET' : 'üî¥ MAINNET';
        const safetyWarning = config.isTestnet ? '(Seguro para testes)' : '(DINHEIRO REAL!)';
        
        ui.status.textContent = `${networkIndicator} ${shortAddr(userAddress)} - ${config.name} ${safetyWarning}`;
        ui.connectBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Conectado';
        ui.connectBtn.className = config.isTestnet ? 'btn btn-warning btn-sm' : 'btn btn-success btn-sm';
        ui.connectionAlert.className = config.isTestnet ? 
          'alert alert-warning d-flex align-items-center' : 
          'alert alert-success d-flex align-items-center';
        
        ui.calculateBtn.disabled = false;
        currentConfig = config;
        
        // Auto-preencher endere√ßo recebedor se vazio
        if (!ui.receiverAddress.value) {
          ui.receiverAddress.value = userAddress;
        }
        
        // Atualizar labels de moeda
        updateCoinLabels(config.nativeCoin);
        
        if (config.isTestnet) {
          log(`üü° CONECTADO √Ä TESTNET: ${config.name}`, 'info');
          log(`üí° Esta √© uma rede de teste. Tokens aqui n√£o t√™m valor real.`, 'info');
          log(`üí° Use https://testnet.binance.org/faucet para obter tBNB gr√°tis`, 'info');
        } else {
          log(`üî¥ CONECTADO √Ä MAINNET: ${config.name}`, 'success');
          log(`‚ö†Ô∏è ATEN√á√ÉO: Esta √© uma rede real. Cuidado com transa√ß√µes!`, 'error');
        }
        
      } else {
        ui.status.textContent = 'MetaMask n√£o conectado';
        ui.connectBtn.innerHTML = '<i class="bi bi-link-45deg me-1"></i>Conectar MetaMask';
        ui.connectBtn.className = 'btn btn-dark btn-sm';
        ui.connectionAlert.className = 'alert alert-warning d-flex align-items-center';
        
        ui.calculateBtn.disabled = true;
        ui.executeBtn.disabled = true;
        ui.transferBtn.disabled = true;
        currentConfig = null;
      }
    }

    // Atualizar labels de moeda nativa
    function updateCoinLabels(coinName) {
      ui.nativeCoinLabel.textContent = coinName;
      ui.totalCoinLabel.textContent = coinName;
    }

    // Alternar entre modos
    function switchPurchaseMode() {
      purchaseMode = ui.modeDex.checked ? 'dex' : 'manual';
      
      if (purchaseMode === 'dex') {
        ui.dexModeFields.style.display = 'block';
        ui.manualModeFields.style.display = 'none';
        ui.executeBtn.style.display = 'block';
        ui.transferBtn.style.display = 'none';
        ui.calculateBtnText.textContent = 'Calcular Pre√ßo DEX';
        ui.executeBtnText.textContent = 'Executar Compra via DEX';
      } else {
        ui.dexModeFields.style.display = 'none';
        ui.manualModeFields.style.display = 'block';
        ui.executeBtn.style.display = 'none';
        ui.transferBtn.style.display = 'block';
        ui.calculateBtnText.textContent = 'Calcular Total Manual';
        ui.transferBtn.disabled = false;
      }
      
      // Reset campos
      ui.expectedTokens.value = '';
      ui.totalCost.value = '';
      ui.executeBtn.disabled = true;
      
      log(`Modo alterado para: ${purchaseMode === 'dex' ? 'DEX (Autom√°tico)' : 'Manual (Voc√™ define pre√ßo)'}`, 'info');
    }

    // Calcular total no modo manual
    function calculateManualTotal() {
      const price = parseFloat(ui.tokenPrice.value || '0');
      const quantity = parseFloat(ui.tokenQuantity.value || '0');
      
      if (price > 0 && quantity > 0) {
        const total = price * quantity;
        ui.totalCost.value = total.toFixed(8);
        log(`C√°lculo manual: ${quantity} tokens √ó ${price} ${currentConfig?.nativeCoin || 'ETH'} = ${total.toFixed(8)} ${currentConfig?.nativeCoin || 'ETH'}`, 'info');
      } else {
        ui.totalCost.value = '';
      }
    }

    // Detectar provider
    function detectProvider() {
      if (typeof window.ethereum === 'undefined') {
        ui.status.textContent = 'MetaMask n√£o detectado';
        ui.connectionAlert.className = 'alert alert-danger d-flex align-items-center';
        ui.connectBtn.disabled = true;
        log('MetaMask n√£o encontrado. Instale MetaMask para continuar.', 'error');
        return false;
      }
      
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      log('MetaMask detectado com sucesso');
      return true;
    }

    // Conectar carteira
    async function connectWallet() {
      if (!window.ethereum) {
        alert('MetaMask n√£o encontrado. Instale MetaMask para continuar.');
        return;
      }

      try {
        log('Solicitando conex√£o com MetaMask...');
        
        const accounts = await window.ethereum.request({ 
          method: 'eth_requestAccounts' 
        });
        
        if (!accounts || accounts.length === 0) {
          log('Nenhuma conta retornada pelo MetaMask', 'error');
          return;
        }

        provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
        signer = provider.getSigner();
        userAddress = accounts[0];

        const network = await provider.getNetwork();
        currentChainId = network.chainId;

        updateConnectionStatus(true, currentChainId);
        
        // Atualizar select de rede
        ui.network.value = currentChainId.toString();
        
      } catch (error) {
        if (error.code === 4001) {
          log('Conex√£o rejeitada pelo usu√°rio', 'error');
        } else {
          log(`Erro ao conectar: ${error.message}`, 'error');
        }
        updateConnectionStatus(false);
      }
    }

    // Calcular pre√ßo
    async function calculatePrice() {
      if (!provider || !currentConfig) {
        alert('Conecte sua carteira primeiro');
        return;
      }

      if (purchaseMode === 'manual') {
        calculateManualTotal();
        return;
      }

      // Modo DEX
      const tokenAddr = ui.tokenAddress.value.trim();
      const ethAmount = ui.ethAmount.value;

      if (!tokenAddr || !ethAmount) {
        alert('Preencha o endere√ßo do token e valor em ETH');
        return;
      }

      try {
        log('Calculando pre√ßo via DEX...');
        ui.expectedTokens.value = 'Calculando...';

        // Router ABI para getAmountsOut
        const routerAbi = [
          'function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)'
        ];

        const router = new ethers.Contract(currentConfig.router, routerAbi, provider);
        const amountIn = ethers.utils.parseEther(ethAmount);
        const path = [currentConfig.weth, tokenAddr];

        const amounts = await router.getAmountsOut(amountIn, path);
        const tokensOut = amounts[1];

        // Obter decimais do token
        const tokenAbi = ['function decimals() view returns (uint8)'];
        const tokenContract = new ethers.Contract(tokenAddr, tokenAbi, provider);
        let decimals = 18;
        
        try {
          decimals = await tokenContract.decimals();
        } catch (e) {
          log('Assumindo 18 decimais para o token', 'info');
        }

        const formattedTokens = ethers.utils.formatUnits(tokensOut, decimals);
        ui.expectedTokens.value = parseFloat(formattedTokens).toFixed(6);
        
        ui.executeBtn.disabled = false;
        
        log(`Pre√ßo via ${currentConfig.dexName}: ${ethAmount} ${currentConfig.nativeCoin} = ${parseFloat(formattedTokens).toFixed(6)} tokens`, 'success');
        
      } catch (error) {
        log(`Erro ao calcular pre√ßo via DEX: ${error.message}`, 'error');
        log('Tente usar o Modo Manual se o token n√£o estiver listado na DEX', 'info');
        ui.expectedTokens.value = 'Token n√£o listado na DEX';
        ui.executeBtn.disabled = true;
      }
    }

    // Executar transfer√™ncia manual (compra + transfer√™ncia autom√°tica)
    async function executeManualTransfer() {
      if (!provider || !signer) {
        alert('Conecte sua carteira primeiro');
        return;
      }

      const tokenAddr = ui.tokenAddress.value.trim();
      const receiverAddr = ui.receiverAddress.value.trim();
      const tokenQuantity = ui.tokenQuantity.value;
      const totalCost = ui.totalCost.value;
      
      if (!tokenAddr || !receiverAddr || !tokenQuantity || !totalCost) {
        alert('Preencha todos os campos do modo manual');
        return;
      }

      try {
        log('üîÑ Iniciando processo de compra manual...');
        
        // Verificar se voc√™ tem os tokens para enviar
        const tokenAbi = [
          'function balanceOf(address owner) view returns (uint256)',
          'function decimals() view returns (uint8)',
          'function transfer(address to, uint256 amount) returns (bool)',
          'function symbol() view returns (string)'
        ];
        
        const tokenContract = new ethers.Contract(tokenAddr, tokenAbi, signer);
        
        log('Verificando informa√ß√µes do token...');
        
        // Obter informa√ß√µes do token
        let decimals = 18;
        let symbol = 'TOKEN';
        let yourBalance = ethers.BigNumber.from('0');
        
        try {
          decimals = await tokenContract.decimals();
          symbol = await tokenContract.symbol();
          yourBalance = await tokenContract.balanceOf(userAddress);
          
          log(`Token: ${symbol} | Decimais: ${decimals}`);
          log(`Seu saldo: ${ethers.utils.formatUnits(yourBalance, decimals)} ${symbol}`);
        } catch (e) {
          log('Erro ao ler informa√ß√µes do token. Verificando se o endere√ßo est√° correto...', 'error');
          throw new Error('Endere√ßo do token inv√°lido ou voc√™ n√£o tem permiss√£o para l√™-lo');
        }

        // Calcular quantidade de tokens em wei
        const tokenAmountWei = ethers.utils.parseUnits(tokenQuantity.toString(), decimals);
        
        // Verificar se voc√™ tem saldo suficiente
        if (yourBalance.lt(tokenAmountWei)) {
          const needed = ethers.utils.formatUnits(tokenAmountWei, decimals);
          const have = ethers.utils.formatUnits(yourBalance, decimals);
          throw new Error(`Saldo insuficiente! Voc√™ tem ${have} ${symbol}, mas precisa de ${needed} ${symbol}`);
        }

        // Passo 1: Receber pagamento do comprador
        const paymentValue = ethers.utils.parseEther(totalCost);
        
        log(`üí∞ Solicitando pagamento de ${totalCost} ${currentConfig.nativeCoin} do comprador...`);
        
        // Nota: Na vida real, isso seria o comprador enviando para voc√™
        // Aqui simulamos como se fosse o comprador pagando
        const paymentTx = await signer.sendTransaction({
          to: userAddress, // Voc√™ recebe o pagamento
          value: paymentValue,
          gasLimit: 21000
        });
        
        log(`‚úÖ Pagamento enviado: ${paymentTx.hash}`, 'success');
        log('‚è≥ Aguardando confirma√ß√£o do pagamento...');
        
        await paymentTx.wait();
        log(`‚úÖ Pagamento confirmado!`, 'success');

        // Passo 2: Enviar tokens automaticamente
        log(`üì§ Enviando ${tokenQuantity} ${symbol} para ${shortAddr(receiverAddr)}...`);
        
        const transferTx = await tokenContract.transfer(receiverAddr, tokenAmountWei, {
          gasLimit: 100000 // Gas suficiente para transfer√™ncia ERC-20
        });
        
        log(`‚úÖ Tokens enviados: ${transferTx.hash}`, 'success');
        log('‚è≥ Aguardando confirma√ß√£o da transfer√™ncia...');
        
        await transferTx.wait();
        
        log(`üéâ TRANSA√á√ÉO COMPLETA!`, 'success');
        log(`üí∞ Recebido: ${totalCost} ${currentConfig.nativeCoin}`);
        log(`üì§ Enviado: ${tokenQuantity} ${symbol}`);
        log(`üîó Hash do pagamento: ${paymentTx.hash}`);
        log(`üîó Hash da transfer√™ncia: ${transferTx.hash}`);
        log(`üåê Explorador: ${currentConfig.blockExplorer}/tx/${transferTx.hash}`);
        
        // Reset form
        ui.tokenPrice.value = '';
        ui.tokenQuantity.value = '';
        ui.totalCost.value = '';

        alert(`‚úÖ Venda realizada com sucesso!\n\nRecebido: ${totalCost} ${currentConfig.nativeCoin}\nEnviado: ${tokenQuantity} ${symbol}\n\nVerifique no explorador: ${currentConfig.blockExplorer}/tx/${transferTx.hash}`);

      } catch (error) {
        if (error.code === 4001) {
          log('‚ùå Transa√ß√£o rejeitada pelo usu√°rio', 'error');
        } else {
          log(`‚ùå Erro na venda: ${error.message}`, 'error');
        }
      }
    }
    async function executePurchase() {
      if (!provider || !signer || !currentConfig) {
        alert('Conecte sua carteira primeiro');
        return;
      }

      const tokenAddr = ui.tokenAddress.value.trim();
      const receiverAddr = ui.receiverAddress.value.trim();
      const ethAmount = ui.ethAmount.value;
      
      if (!tokenAddr || !receiverAddr || !ethAmount) {
        alert('Preencha todos os campos obrigat√≥rios');
        return;
      }

      try {
        log('Preparando transa√ß√£o de compra...');

        // Obter amounts out novamente
        const routerAbi = [
          'function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)',
          'function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)'
        ];

        const router = new ethers.Contract(currentConfig.router, routerAbi, signer);
        const amountIn = ethers.utils.parseEther(ethAmount);
        const path = [currentConfig.weth, tokenAddr];

        const amounts = await router.getAmountsOut(amountIn, path);
        const expectedOut = amounts[1];
        // Usar 95% como slippage padr√£o (5% de toler√¢ncia)
        const minAmountOut = expectedOut.mul(95).div(100);

        // Deadline de 20 minutos
        const deadline = Math.floor(Date.now() / 1000) + (20 * 60);

        log(`Executando swap: ${ethAmount} ${currentConfig.nativeCoin} ‚Üí tokens via ${currentConfig.dexName}`);

        const tx = await router.swapExactETHForTokens(
          minAmountOut,
          path,
          receiverAddr,
          deadline,
          { value: amountIn }
        );

        log(`Transa√ß√£o enviada: ${tx.hash}`, 'success');
        log(`Aguardando confirma√ß√£o...`);

        const receipt = await tx.wait();
        
        log(`‚úÖ Compra realizada com sucesso!`, 'success');
        log(`Hash: ${tx.hash}`);
        log(`Explorador: ${currentConfig.blockExplorer}/tx/${tx.hash}`);
        
        // Reset form
        ui.ethAmount.value = '';
        ui.expectedTokens.value = '';
        ui.executeBtn.disabled = true;

      } catch (error) {
        if (error.code === 4001) {
          log('Transa√ß√£o rejeitada pelo usu√°rio', 'error');
        } else {
          log(`Erro na compra: ${error.message}`, 'error');
        }
      }
    }

    // Event listeners
    ui.connectBtn.addEventListener('click', connectWallet);
    ui.calculateBtn.addEventListener('click', calculatePrice);
    ui.executeBtn.addEventListener('click', executePurchase);
    ui.transferBtn.addEventListener('click', executeManualTransfer);
    
    // Mode switching
    ui.modeDex.addEventListener('change', switchPurchaseMode);
    ui.modeManual.addEventListener('change', switchPurchaseMode);
    
    // Manual mode calculations
    ui.tokenPrice.addEventListener('input', calculateManualTotal);
    ui.tokenQuantity.addEventListener('input', calculateManualTotal);
    
    // Auto-calcular quando mudar valores (modo DEX)
    ui.ethAmount.addEventListener('input', () => {
      if (purchaseMode === 'dex' && ui.ethAmount.value && ui.tokenAddress.value) {
        ui.expectedTokens.value = 'Clique em calcular para atualizar';
        ui.executeBtn.disabled = true;
      }
    });

    ui.tokenAddress.addEventListener('input', () => {
      if (purchaseMode === 'dex') {
        ui.expectedTokens.value = '';
        ui.executeBtn.disabled = true;
      }
    });

    // Mudan√ßa de rede
    ui.network.addEventListener('change', () => {
      const selectedChain = parseInt(ui.network.value);
      if (currentChainId !== selectedChain) {
        log(`Mudan√ßa de rede necess√°ria: ${DEX_CONFIG[selectedChain]?.name}`);
        // Aqui poderia solicitar mudan√ßa de rede via MetaMask
      }
    });

    // Listeners para mudan√ßas da carteira
    function setupWalletListeners() {
      if (!window.ethereum) return;

      window.ethereum.on('accountsChanged', (accounts) => {
        if (!accounts || accounts.length === 0) {
          log('Carteira desconectada');
          userAddress = null;
          updateConnectionStatus(false);
        } else {
          userAddress = accounts[0];
          updateConnectionStatus(true, currentChainId);
          log(`Conta alterada: ${shortAddr(userAddress)}`);
        }
      });

      window.ethereum.on('chainChanged', (chainIdHex) => {
        const chainId = parseInt(chainIdHex, 16);
        currentChainId = chainId;
        currentConfig = DEX_CONFIG[chainId];
        updateConnectionStatus(true, chainId);
        ui.network.value = chainId.toString();
        log(`Rede alterada: ${currentConfig?.name || `Chain ${chainId}`}`);
        
        // Reset c√°lculos
        ui.expectedTokens.value = '';
        ui.executeBtn.disabled = true;
      });
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', async function() {
      log('üöÄ SCCAFE Token Purchase iniciado');
      
      // Configurar modo inicial
      switchPurchaseMode();
      
      if (detectProvider()) {
        setupWalletListeners();
        
        // Verificar se j√° est√° conectado
        try {
          const accounts = await provider.listAccounts();
          if (accounts && accounts.length > 0) {
            signer = provider.getSigner();
            userAddress = accounts[0];
            const network = await provider.getNetwork();
            currentChainId = network.chainId;
            updateConnectionStatus(true, currentChainId);
            ui.network.value = currentChainId.toString();
          } else {
            updateConnectionStatus(false);
          }
        } catch (error) {
          log('Erro ao verificar conex√£o existente', 'error');
          updateConnectionStatus(false);
        }
      }
    });

  </script>
  
  <!-- Footer -->
  <footer class="bg-secondary mt-5 py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h6 class="text-white mb-3">‚úÖ Sistema de Compra de Tokens SCCAFE</h6>
          <ul class="list-unstyled text-muted small mb-0">
            <li class="mb-2">üü¢ <strong>Transfer√™ncias Autom√°ticas:</strong> Recebe pagamento e envia tokens automaticamente</li>
            <li class="mb-2">üü° <strong>Testnet Seguro:</strong> Use BSC Testnet para testes sem custo real</li>
            <li class="mb-2">üîµ <strong>Multi-Chain:</strong> Suporte a Ethereum, BSC, Polygon, Avalanche</li>
            <li class="mb-2">üü£ <strong>Dual Mode:</strong> DEX autom√°tico para tokens listados, Manual para seus tokens</li>
          </ul>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="text-muted small">
            <div class="mb-2">
              <strong>Links √öteis:</strong><br>
              <a href="add-index.html" class="text-primary">Criar Token</a> |
              <a href="index.html" class="text-primary">Home</a>
            </div>
            <div>
              <strong>Para Teste:</strong><br>
              <a href="https://testnet.binance.org/faucet" target="_blank" class="text-primary">tBNB Gr√°tis</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>