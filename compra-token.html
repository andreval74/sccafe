<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compra Direta TKN</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
<h2>Compra Direta de TKN</h2>

<div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; background-color: #f9f9f9;">
    <h4>ðŸ’° InformaÃ§Ãµes do Token</h4>
    <p><strong>PreÃ§o por token:</strong> <span id="tokenPriceDisplay">0.003 BNB</span></p>
    <p><strong>EndereÃ§o do contrato:</strong> <span id="contractDisplay">0x5265F80e30e019344a218Dd89b67cBE164511c65</span></p>
    <p><strong>Nome do token:</strong> <span id="tokenName">Carregando...</span></p>
    <p><strong>SÃ­mbolo:</strong> <span id="tokenSymbol">Carregando...</span></p>
    <p><strong>Tokens disponÃ­veis no contrato:</strong> <span id="tokenBalance">Carregando...</span></p>
    <p><strong>Total supply:</strong> <span id="totalSupply">Carregando...</span></p>
</div>

<button id="checkContract">Verificar Contrato e Tokens</button>
<br><br>
<label>Quantidade de Tokens:</label>
<input type="number" id="tokenAmount" placeholder="Quantidade de tokens" min="1" oninput="calculateTotal()">
<br><br>

<div id="calculationDisplay" style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; background-color: #f0f8ff; display: none;">
    <h4>ðŸ§® CÃ¡lculo da Compra</h4>
    <p><strong>Quantidade de tokens:</strong> <span id="calcTokens">0</span></p>
    <p><strong>PreÃ§o unitÃ¡rio:</strong> <span id="calcPrice">0.003 BNB</span></p>
    <p><strong>Total a pagar:</strong> <span id="calcTotal">0 BNB</span></p>
    <p><strong>DisponÃ­vel no contrato:</strong> <span id="calcAvailable">Verificar contrato primeiro</span></p>
    <p id="availabilityStatus" style="font-weight: bold;"></p>
</div>

<button id="buyButton">Comprar</button>

<p id="status"></p>
<ul id="errorList" style="color:red;"></ul>

<div id="transactionDetails" style="border: 1px solid #28a745; padding: 10px; margin: 10px 0; background-color: #d4edda; display: none;">
    <h4>ðŸ“Š Detalhes da TransaÃ§Ã£o</h4>
    <p><strong>Hash da transaÃ§Ã£o:</strong> <span id="txHash"></span></p>
    <p><strong>Valor enviado:</strong> <span id="txValue"></span> BNB</p>
    <p><strong>Gas usado:</strong> <span id="txGas"></span></p>
    <p><strong>Taxa de gas:</strong> <span id="txGasPrice"></span> BNB</p>
    <p><strong>Total pago (incluindo gas):</strong> <span id="txTotalCost"></span> BNB</p>
    <hr>
    <p><strong>ðŸŽ¯ Destino dos valores:</strong></p>
    <p>â€¢ <strong>Para o contrato (compra tokens):</strong> <span id="txToContract"></span> BNB</p>
    <p>â€¢ <strong>Taxa de rede (gas):</strong> <span id="txNetworkFee"></span> BNB</p>
    <p>â€¢ <strong>Tokens recebidos (estimativa):</strong> <span id="txTokensReceived"></span> TKN</p>
</div>

<script>
const contractAddress = "0x5265F80e30e019344a218Dd89b67cBE164511c65"; // EndereÃ§o do TKN na testnet
const tokenDecimals = 18; // Decimais do token
const tokenPrice = ethers.utils.parseEther("0.003"); // PreÃ§o inicial em tBNB por token
const tokenPriceFormatted = "0.003"; // Para exibiÃ§Ã£o

// ABI bÃ¡sico do ERC-20 para verificar saldo
const tokenABI = [
    "function balanceOf(address owner) view returns (uint256)",
    "function totalSupply() view returns (uint256)",
    "function name() view returns (string)",
    "function symbol() view returns (string)"
];

let provider;
let signer;

// FunÃ§Ã£o para calcular total em tempo real
function calculateTotal() {
    const amount = document.getElementById("tokenAmount").value;
    const calcDiv = document.getElementById("calculationDisplay");
    
    if (amount && amount > 0) {
        const total = parseFloat(amount) * parseFloat(tokenPriceFormatted);
        
        document.getElementById("calcTokens").textContent = amount;
        document.getElementById("calcPrice").textContent = tokenPriceFormatted + " BNB";
        document.getElementById("calcTotal").textContent = total.toFixed(6) + " BNB";
        
        // Verificar disponibilidade
        const availableText = document.getElementById("tokenBalance").textContent;
        if (availableText !== "Carregando..." && availableText !== "N/A") {
            const available = parseFloat(availableText);
            document.getElementById("calcAvailable").textContent = available.toLocaleString() + " tokens";
            
            const statusEl = document.getElementById("availabilityStatus");
            if (parseFloat(amount) <= available) {
                statusEl.textContent = "âœ… Quantidade disponÃ­vel";
                statusEl.style.color = "green";
            } else {
                statusEl.textContent = "âŒ Quantidade indisponÃ­vel (mÃ¡ximo: " + available.toLocaleString() + ")";
                statusEl.style.color = "red";
            }
        } else {
            document.getElementById("calcAvailable").textContent = "Verificar contrato primeiro";
            document.getElementById("availabilityStatus").textContent = "";
        }
        
        calcDiv.style.display = "block";
    } else {
        calcDiv.style.display = "none";
    }
}

// Atualizar displays iniciais
document.getElementById("tokenPriceDisplay").textContent = tokenPriceFormatted + " BNB";
document.getElementById("contractDisplay").textContent = contractAddress;

async function connectWallet() {
    if (window.ethereum) {
        try {
            // Verificar conectividade bÃ¡sica primeiro
            await window.ethereum.request({ method: 'eth_chainId' });
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            
            // Verificar se consegue obter o endereÃ§o
            const address = await signer.getAddress();
            document.getElementById("status").innerText = "Carteira conectada: " + address;
            
            // Verificar rede
            const network = await provider.getNetwork();
            if (network.chainId !== 97) {
                addError("âš ï¸ VocÃª estÃ¡ na rede " + network.name + " (chainId: " + network.chainId + ")");
                addError("Por favor, mude para BSC Testnet (chainId: 97)");
            } else {
                addError("âœ… Conectado Ã  BSC Testnet");
            }
            
        } catch (err) {
            addError("Erro ao conectar carteira: " + err.message);
            throw err;
        }
    } else {
        alert("Instale a Metamask ou outro provedor Web3!");
    }
}

async function buyTokens() {
    clearErrors();
    const amountInput = document.getElementById("tokenAmount").value;
    if (!amountInput || amountInput <= 0) {
        addError("Informe a quantidade de tokens.");
        return;
    }

    if (!signer) {
        addError("Carteira nÃ£o conectada.");
        return;
    }

    let amountBNB, amountWei;
    try {
        amountBNB = tokenPrice.mul(ethers.BigNumber.from(amountInput));
        amountWei = amountBNB;
        addError(`ðŸ’° Valor calculado: ${ethers.utils.formatEther(amountWei)} BNB para ${amountInput} tokens`);
    } catch (err) {
        addError("Erro ao calcular valor em BNB: " + err.message);
        return;
    }

    try {
        document.getElementById("status").innerText = "Enviando transaÃ§Ã£o...";
        
        // Obter saldo antes da transaÃ§Ã£o
        const balanceBefore = await signer.getBalance();
        addError(`ðŸ’³ Saldo antes: ${ethers.utils.formatEther(balanceBefore)} BNB`);
        
        // TransaÃ§Ã£o
        const tx = await signer.sendTransaction({
            to: contractAddress,
            value: amountWei,
            gasLimit: 100000 // Gas fixo para evitar estimativa
        });
        
        document.getElementById("status").innerText = "TransaÃ§Ã£o enviada. Aguarde confirmaÃ§Ã£o...";
        const receipt = await tx.wait();
        
        // Obter saldo apÃ³s a transaÃ§Ã£o
        const balanceAfter = await signer.getBalance();
        const totalSpent = balanceBefore.sub(balanceAfter);
        const gasFee = receipt.gasUsed.mul(receipt.effectiveGasPrice);
        
        // Mostrar detalhes da transaÃ§Ã£o
        document.getElementById("txHash").textContent = tx.hash;
        document.getElementById("txValue").textContent = ethers.utils.formatEther(amountWei);
        document.getElementById("txGas").textContent = receipt.gasUsed.toString();
        document.getElementById("txGasPrice").textContent = ethers.utils.formatEther(gasFee);
        document.getElementById("txTotalCost").textContent = ethers.utils.formatEther(totalSpent);
        document.getElementById("txToContract").textContent = ethers.utils.formatEther(amountWei);
        document.getElementById("txNetworkFee").textContent = ethers.utils.formatEther(gasFee);
        document.getElementById("txTokensReceived").textContent = amountInput;
        
        // Mostrar div de detalhes
        document.getElementById("transactionDetails").style.display = "block";
        
        document.getElementById("status").innerText = `âœ… Compra concluÃ­da! Hash: ${tx.hash}`;
        addError(`ðŸ’³ Saldo apÃ³s: ${ethers.utils.formatEther(balanceAfter)} BNB`);
        addError(`ðŸ’¸ Total gasto: ${ethers.utils.formatEther(totalSpent)} BNB`);
        
    } catch (err) {
        addError("âŒ Erro na transaÃ§Ã£o: " + err.message);
        if (err.reason) {
            addError("Motivo: " + err.reason);
        }
        if (err.code) {
            addError("CÃ³digo do erro: " + err.code);
        }
    }
}

async function checkContract() {
    clearErrors();
    
    // Tentar com um provider pÃºblico da BSC Testnet
    const publicProvider = new ethers.providers.JsonRpcProvider("https://data-seed-prebsc-1-s1.binance.org:8545/");
    
    try {
        addError("ðŸ” Verificando contrato...");
        
        // Verificar se existe cÃ³digo no endereÃ§o
        const code = await publicProvider.getCode(contractAddress);
        
        if (code === '0x') {
            addError("âŒ PROBLEMA: NÃ£o existe contrato neste endereÃ§o!");
            addError("O endereÃ§o pode estar incorreto ou o contrato nÃ£o foi deployed na BSC Testnet.");
            return;
        } else {
            addError("âœ… Contrato encontrado no endereÃ§o.");
        }
        
        // Verificar saldo do contrato em BNB
        const balance = await publicProvider.getBalance(contractAddress);
        addError(`ðŸ’° Saldo BNB do contrato: ${ethers.utils.formatEther(balance)} BNB`);
        
        // Verificar conectividade da rede
        const blockNumber = await publicProvider.getBlockNumber();
        addError(`ðŸ“¡ Bloco atual BSC Testnet: ${blockNumber}`);
        
        // Tentar acessar as funÃ§Ãµes do token ERC-20
        try {
            const tokenContract = new ethers.Contract(contractAddress, tokenABI, publicProvider);
            
            // Obter informaÃ§Ãµes bÃ¡sicas do token
            const name = await tokenContract.name();
            const symbol = await tokenContract.symbol();
            const totalSupply = await tokenContract.totalSupply();
            const contractTokenBalance = await tokenContract.balanceOf(contractAddress);
            
            // Atualizar interface
            document.getElementById("tokenName").textContent = name;
            document.getElementById("tokenSymbol").textContent = symbol;
            document.getElementById("totalSupply").textContent = ethers.utils.formatUnits(totalSupply, tokenDecimals);
            document.getElementById("tokenBalance").textContent = ethers.utils.formatUnits(contractTokenBalance, tokenDecimals);
            
            addError(`âœ… Token: ${name} (${symbol})`);
            addError(`ðŸ“Š Total Supply: ${ethers.utils.formatUnits(totalSupply, tokenDecimals)} ${symbol}`);
            addError(`ðŸª™ Tokens disponÃ­veis no contrato: ${ethers.utils.formatUnits(contractTokenBalance, tokenDecimals)} ${symbol}`);
            
            // Verificar se tem tokens suficientes para venda
            if (contractTokenBalance.gt(0)) {
                addError("âœ… Contrato tem tokens disponÃ­veis para venda.");
            } else {
                addError("âš ï¸ ATENÃ‡ÃƒO: Contrato nÃ£o tem tokens para venda!");
            }
            
        } catch (tokenErr) {
            addError("âš ï¸ NÃ£o foi possÃ­vel acessar funÃ§Ãµes ERC-20: " + tokenErr.message);
            addError("O contrato pode nÃ£o ser um token ERC-20 padrÃ£o.");
            
            // Resetar displays
            document.getElementById("tokenName").textContent = "N/A";
            document.getElementById("tokenSymbol").textContent = "N/A";
            document.getElementById("totalSupply").textContent = "N/A";
            document.getElementById("tokenBalance").textContent = "N/A";
        }
        
    } catch (err) {
        addError("âŒ Erro ao verificar contrato: " + err.message);
        addError("ðŸ’¡ Pode ser um problema de conectividade com a BSC Testnet.");
    }
}

// FunÃ§Ãµes para manipular lista de erros
function addError(msg) {
    const ul = document.getElementById("errorList");
    const li = document.createElement("li");
    li.textContent = msg;
    ul.appendChild(li);
}
function clearErrors() {
    document.getElementById("errorList").innerHTML = "";
}

// Eventos dos botÃµes
document.getElementById("checkContract").addEventListener("click", checkContract);
document.getElementById("buyButton").addEventListener("click", async () => {
    clearErrors();
    try {
        if (!signer) await connectWallet();
        await buyTokens();
    } catch (err) {
        addError("Erro inesperado: " + err.message);
    }
});
</script>
</body>
</html>
