<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compra de Tokens - SCCAFE</title>
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="imgs/sccafe-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="imgs/sccafe-32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="imgs/sccafe-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="imgs/sc        // Calcular quantidade de tokens em wei
        const tokenAmountWei = ethers.utils.parseUnits(tokenQuantity.toString(), decimals);
        
        log(`üîç Debug: Enviando ${tokenQuantity} tokens`);
        log(`üîç Debug: Decimais do token: ${decimals}`);
        log(`üîç Debug: Valor em Wei: ${tokenAmountWei.toString()}`);
        log(`üîç Debug: Seu saldo em Wei: ${yourBalance.toString()}`);
        log(`üîç Debug: Endere√ßo destino: ${receiverAddr}`);
        
        // Verificar se voc√™ tem saldo suficiente
        if (yourBalance.lt(tokenAmountWei)) {
          const needed = ethers.utils.formatUnits(tokenAmountWei, decimals);2.png">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- SCCAFE Global CSS Unificado -->
  <link href="styles/globals.css" rel="stylesheet">
  
  <!-- Meta tags SEO -->
  <meta name="description" content="Compre tokens diretamente via MetaMask com os melhores pre√ßos do mercado. Suporte para Ethereum, BSC, Polygon e outras redes.">
  <meta name="keywords" content="comprar token, metamask, pancakeswap, uniswap, DEX, swap, SCCAFE">
</head>
<body>
  <!-- Header -->
  <header data-component="header"></header>
  
  <!-- Main Content -->
  <main class="token-purchase-main py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
          <!-- Page Header -->
          <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-white mb-3">
              <i class="bi bi-cart-check text-primary me-3"></i>Compra de Tokens
            </h1>
            <p class="lead text-secondary">
              Compre tokens diretamente via MetaMask com os melhores pre√ßos das principais DEXs
            </p>
          </div>
          
          <!-- Purchase Card -->
          <div class="card bg-dark border-primary shadow-lg">
            <!-- Connection Status -->
            <div class="card-header bg-primary text-dark">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-wallet2 me-2"></i>Status da Conex√£o
                </h5>
                <button id="connectBtn" class="btn btn-dark btn-sm">
                  <i class="bi bi-link-45deg me-1"></i>Conectar MetaMask
                </button>
              </div>
            </div>

            
            <div class="card-body p-4">
              <!-- Connection Status Display -->
              <div class="connection-status mb-4">
                <div class="alert alert-info d-flex align-items-center" id="connectionAlert">
                  <i class="bi bi-info-circle me-2"></i>
                  <span id="status">Detectando MetaMask...</span>
                </div>
                <div class="text-center">
                  <small class="text-muted">
                    N√£o tem MetaMask? 
                    <a href="https://metamask.io/" target="_blank" class="text-primary text-decoration-none fw-bold">
                      <i class="bi bi-download me-1"></i>Instalar aqui
                    </a>
                  </small>
                </div>
              </div>

              <!-- Purchase Form -->
              <form id="purchaseForm">
                <!-- Info Banner -->
                <div class="alert alert-info">
                  <h6 class="alert-heading">
                    <i class="bi bi-info-circle me-2"></i>Sistema de Venda de Tokens SCCAFE
                  </h6>
                  <p class="mb-0">
                    Defina o pre√ßo dos seus tokens criados no SCCAFE. O sistema receber√° o pagamento e transferir√° os tokens automaticamente.
                  </p>
                </div>

                <!-- Token Selection -->
                <div class="row g-4 mb-4">
                  <div class="col-md-8">
                    <label for="tokenAddress" class="form-label text-white">
                      <i class="bi bi-coin text-primary me-2"></i>Endere√ßo do Token (ERC-20/BEP-20)
                    </label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" 
                           id="tokenAddress" placeholder="0x..." required>
                    <div class="form-text text-muted">Endere√ßo do contrato do token que deseja comprar</div>
                  </div>
                  <div class="col-md-4">
                    <label for="network" class="form-label text-white">
                      <i class="bi bi-globe text-primary me-2"></i>Rede Blockchain
                    </label>
                    <select class="form-control bg-dark text-white border-secondary" id="network">
                      <optgroup label="üî¥ MAINNETS (Dinheiro Real)">
                        <option value="1">Ethereum Mainnet</option>
                        <option value="56">BSC Mainnet</option>
                        <option value="137">Polygon Mainnet</option>
                        <option value="43114">Avalanche Mainnet</option>
                      </optgroup>
                      <optgroup label="üü° TESTNETS (Para Testes - Recomendado)">
                        <option value="11155111">Sepolia Testnet</option>
                        <option value="97" selected>BSC Testnet</option>
                        <option value="80001">Mumbai Testnet</option>
                        <option value="43113">Fuji Testnet</option>
                      </optgroup>
                    </select>
                    <div class="form-text text-muted">‚≠ê Use BSC Testnet para testes seguros</div>
                  </div>
                </div>

                <!-- Receiver Address -->
                <div class="mb-4">
                  <label for="receiverAddress" class="form-label text-white">
                    <i class="bi bi-person-badge text-primary me-2"></i>Endere√ßo Recebedor
                  </label>
                  <input type="text" class="form-control bg-dark text-white border-secondary" 
                         id="receiverAddress" placeholder="0x..." required>
                  <div class="form-text text-muted">Endere√ßo que receber√° os tokens comprados (deixe vazio para usar sua carteira)</div>
                </div>

                <!-- Token Sale Configuration -->
                <div class="row g-4 mb-4">
                  <div class="col-md-4">
                    <label for="tokenPrice" class="form-label text-white">
                      <i class="bi bi-tag text-primary me-2"></i>Pre√ßo por Token
                    </label>
                    <div class="input-group">
                      <input type="number" class="form-control bg-dark text-white border-secondary" 
                             id="tokenPrice" placeholder="0.001" step="0.0001" min="0.0001" required>
                      <span class="input-group-text bg-secondary text-white" id="nativeCoinLabel">ETH</span>
                    </div>
                    <div class="form-text text-muted">Pre√ßo que voc√™ est√° cobrando por cada token</div>
                  </div>
                  <div class="col-md-4">
                    <label for="tokenQuantity" class="form-label text-white">
                      <i class="bi bi-123 text-primary me-2"></i>Quantidade de Tokens
                    </label>
                    <input type="number" class="form-control bg-dark text-white border-secondary" 
                           id="tokenQuantity" placeholder="1000" step="1" min="1" required>
                    <div class="form-text text-muted">Quantos tokens o comprador receber√°</div>
                  </div>
                  <div class="col-md-4">
                    <label for="totalCost" class="form-label text-white">
                      <i class="bi bi-calculator text-primary me-2"></i>Custo Total
                    </label>
                    <div class="input-group">
                      <input type="text" class="form-control bg-dark text-white border-secondary" 
                             id="totalCost" placeholder="0.000" readonly>
                      <span class="input-group-text bg-secondary text-white" id="totalCostCoin">ETH</span>
                    </div>
                    <div class="form-text text-muted">Valor total que o comprador pagar√°</div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                  <button type="button" id="transferBtn" class="btn btn-primary btn-lg" disabled>
                    <i class="bi bi-send me-2"></i>Processar Venda (Receber Pagamento + Enviar Tokens)
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Transaction Log -->
          <div class="card bg-dark border-secondary mt-4">
            <div class="card-header">
              <h5 class="mb-0 text-white">
                <i class="bi bi-journal-text text-primary me-2"></i>Log de Transa√ß√µes
              </h5>
            </div>
            <div class="card-body">
              <pre id="log" class="bg-black text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">Aguardando a√ß√£o do usu√°rio...</pre>
            </div>
          </div>

          <!-- Help Section -->
          <div class="card bg-secondary mt-4">
            <div class="card-body">
              <h6 class="text-white mb-3">
                <i class="bi bi-info-circle text-primary me-2"></i>Sistema de Venda de Tokens SCCAFE
              </h6>
              
              <!-- Testnet Info -->
              <div class="alert alert-warning mb-3">
                <h6 class="alert-heading">üü° Para Testes Seguros (Recomendado)</h6>
                <p class="mb-2">Use <strong>BSC Testnet</strong> para testar sem gastar dinheiro real:</p>
                <ol class="mb-2">
                  <li>Conecte √† <strong>BSC Testnet</strong> no MetaMask</li>
                  <li>Obtenha <strong>tBNB gr√°tis</strong>: <a href="https://testnet.binance.org/faucet" target="_blank" class="text-primary">https://testnet.binance.org/faucet</a></li>
                  <li>Use o endere√ßo do seu token criado no SCCAFE</li>
                  <li>Defina pre√ßo e quantidade - sistema faz o resto!</li>
                </ol>
              </div>
              
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="text-center">
                    <i class="bi bi-wallet2 text-primary" style="font-size: 2rem;"></i>
                    <h6 class="text-white mt-2">1. Configure</h6>
                    <small class="text-muted">Token, pre√ßo e quantidade que quer vender</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center">
                    <i class="bi bi-currency-exchange text-primary" style="font-size: 2rem;"></i>
                    <h6 class="text-white mt-2">2. Recebe Pagamento</h6>
                    <small class="text-muted">Sistema recebe o pagamento do comprador</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center">
                    <i class="bi bi-send text-primary" style="font-size: 2rem;"></i>
                    <h6 class="text-white mt-2">3. Envia Tokens</h6>
                    <small class="text-muted">Sistema transfere tokens automaticamente para o comprador</small>
                  </div>
                </div>
              </div>
              
              <!-- Faucets -->
              <div class="mt-3">
                <h6 class="text-white">üö∞ Faucets para Testes (Tokens Gr√°tis):</h6>
                <ul class="list-unstyled text-muted small">
                  <li>‚Ä¢ <strong>tBNB:</strong> <a href="https://testnet.binance.org/faucet" target="_blank" class="text-primary">BSC Testnet Faucet</a></li>
                  <li>‚Ä¢ <strong>tETH:</strong> <a href="https://faucets.chain.link/sepolia" target="_blank" class="text-primary">Chainlink Sepolia Faucet</a></li>
                  <li>‚Ä¢ <strong>tMATIC:</strong> <a href="https://faucet.polygon.technology/" target="_blank" class="text-primary">Polygon Mumbai Faucet</a></li>
                  <li>‚Ä¢ <strong>tAVAX:</strong> <a href="https://faucet.avax.network/" target="_blank" class="text-primary">Avalanche Fuji Faucet</a></li>
                </ul>
                
                <div class="alert alert-info mt-3">
                  <h6 class="alert-heading">üí° Dica: Teste com seu pr√≥prio token</h6>
                  <p class="mb-0">
                    1. V√° em <a href="add-index.html" class="text-primary"><strong>Criar Token</strong></a> e crie um token de teste na BSC Testnet<br>
                    2. Volte aqui e use o <strong>Modo Manual</strong> com o endere√ßo do seu token<br>
                    3. Teste comprando com tBNB - √© gr√°tis e funciona perfeitamente!
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer data-component="footer"></footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Template Loader -->
  <script src="js/template-loader.js"></script>

  <script>
    /**
     * SCCAFE Token Purchase System
     * Suporte para m√∫ltiplas DEXs: PancakeSwap, Uniswap, QuickSwap, Trader Joe
     */

    // Configura√ß√µes das redes blockchain suportadas
    const NETWORK_CONFIG = {
      1: { // Ethereum Mainnet
        name: 'Ethereum Mainnet',
        nativeCoin: 'ETH',
        blockExplorer: 'https://etherscan.io',
        isTestnet: false
      },
      11155111: { // Ethereum Sepolia Testnet
        name: 'Sepolia Testnet',
        nativeCoin: 'tETH',
        blockExplorer: 'https://sepolia.etherscan.io',
        isTestnet: true
      },
      56: { // BSC Mainnet
        name: 'BSC Mainnet',
        nativeCoin: 'BNB',
        blockExplorer: 'https://bscscan.com',
        isTestnet: false
      },
      97: { // BSC Testnet
        name: 'BSC Testnet',
        nativeCoin: 'tBNB',
        blockExplorer: 'https://testnet.bscscan.com',
        isTestnet: true
      },
      137: { // Polygon Mainnet
        name: 'Polygon Mainnet',
        nativeCoin: 'MATIC',
        blockExplorer: 'https://polygonscan.com',
        isTestnet: false
      },
      80001: { // Polygon Mumbai Testnet
        name: 'Mumbai Testnet',
        nativeCoin: 'tMATIC',
        blockExplorer: 'https://mumbai.polygonscan.com',
        isTestnet: true
      },
      43114: { // Avalanche Mainnet
        name: 'Avalanche Mainnet',
        nativeCoin: 'AVAX',
        blockExplorer: 'https://snowtrace.io',
        isTestnet: false
      },
      43113: { // Avalanche Fuji Testnet
        name: 'Fuji Testnet',
        nativeCoin: 'tAVAX',
        blockExplorer: 'https://testnet.snowtrace.io',
        isTestnet: true
      }
    };

    // Estado global
    let provider = null;
    let signer = null;
    let userAddress = null;
    let currentChainId = null;
    let currentConfig = null;
    let purchaseMode = 'dex'; // 'dex' ou 'manual'

    // Elementos da UI
    const ui = {
      status: document.getElementById('status'),
      connectBtn: document.getElementById('connectBtn'),
      transferBtn: document.getElementById('transferBtn'),
      connectionAlert: document.getElementById('connectionAlert'),
      
      nativeCoinLabel: document.getElementById('nativeCoinLabel'),
      totalCostCoin: document.getElementById('totalCostCoin'),
      
      tokenAddress: document.getElementById('tokenAddress'),
      receiverAddress: document.getElementById('receiverAddress'),
      network: document.getElementById('network'),
      
      // Token sale fields
      tokenPrice: document.getElementById('tokenPrice'),
      tokenQuantity: document.getElementById('tokenQuantity'),
      totalCost: document.getElementById('totalCost'),
      
      log: document.getElementById('log')
    };

    // Fun√ß√µes utilit√°rias
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      ui.log.textContent = `[${timestamp}] ${icon} ${message}\n` + ui.log.textContent;
      console.log(`[SCCAFE Purchase] ${message}`);
    }

    function shortAddr(addr) {
      if (!addr) return '';
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

    function updateConnectionStatus(connected, chainId = null) {
      // Verifica√ß√£o de seguran√ßa para elementos UI
      if (!ui.status || !ui.connectBtn || !ui.connectionAlert) {
        console.warn('Elementos de UI n√£o encontrados para updateConnectionStatus');
        return;
      }
      
      if (connected && userAddress) {
        const config = NETWORK_CONFIG[chainId] || { name: `Chain ${chainId}`, nativeCoin: 'ETH', isTestnet: false };
        
        // Indicador visual para testnet
        const networkIndicator = config.isTestnet ? 'üü° TESTNET' : 'üî¥ MAINNET';
        const safetyWarning = config.isTestnet ? '(Seguro para testes)' : '(DINHEIRO REAL!)';
        
        ui.status.textContent = `${networkIndicator} ${shortAddr(userAddress)} - ${config.name} ${safetyWarning}`;
        ui.connectBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Conectado';
        ui.connectBtn.className = config.isTestnet ? 'btn btn-warning btn-sm' : 'btn btn-success btn-sm';
        ui.connectionAlert.className = config.isTestnet ? 
          'alert alert-warning d-flex align-items-center' : 
          'alert alert-success d-flex align-items-center';
        
        if (ui.transferBtn) ui.transferBtn.disabled = false;
        currentConfig = config;
        
        // Auto-preencher endere√ßo recebedor se vazio
        if (ui.receiverAddress && !ui.receiverAddress.value) {
          ui.receiverAddress.value = userAddress;
        }
        
        // Atualizar labels de moeda
        updateCoinLabels(config.nativeCoin);
        
        if (config.isTestnet) {
          log(`üü° CONECTADO √Ä TESTNET: ${config.name}`, 'info');
          log(`üí° Esta √© uma rede de teste. Tokens aqui n√£o t√™m valor real.`, 'info');
          log(`üí° Use https://testnet.binance.org/faucet para obter tBNB gr√°tis`, 'info');
        } else {
          log(`üî¥ CONECTADO √Ä MAINNET: ${config.name}`, 'success');
          log(`‚ö†Ô∏è ATEN√á√ÉO: Esta √© uma rede real. Cuidado com transa√ß√µes!`, 'error');
        }
        
      } else {
        ui.status.textContent = 'MetaMask n√£o conectado';
        ui.connectBtn.innerHTML = '<i class="bi bi-link-45deg me-1"></i>Conectar MetaMask';
        ui.connectBtn.className = 'btn btn-dark btn-sm';
        ui.connectionAlert.className = 'alert alert-warning d-flex align-items-center';
        
        if (ui.transferBtn) ui.transferBtn.disabled = true;
        currentConfig = null;
      }
    }

    // Atualizar labels de moeda nativa
    function updateCoinLabels(coinName) {
      if (ui.nativeCoinLabel) ui.nativeCoinLabel.textContent = coinName;
      if (ui.totalCostCoin) ui.totalCostCoin.textContent = coinName;
    }

    // Calcular total no modo manual
    function calculateManualTotal() {
      const price = parseFloat(ui.tokenPrice.value || '0');
      const quantity = parseFloat(ui.tokenQuantity.value || '0');
      
      if (price > 0 && quantity > 0) {
        const total = price * quantity;
        ui.totalCost.value = total.toFixed(8);
        log(`C√°lculo: ${quantity} tokens √ó ${price} ${currentConfig?.nativeCoin || 'ETH'} = ${total.toFixed(8)} ${currentConfig?.nativeCoin || 'ETH'}`, 'info');
        ui.transferBtn.disabled = false;
      } else {
        ui.totalCost.value = '';
        ui.transferBtn.disabled = true;
      }
    }

    // Detectar provider
    function detectProvider() {
      if (typeof window.ethereum === 'undefined') {
        ui.status.textContent = 'MetaMask n√£o detectado';
        ui.connectionAlert.className = 'alert alert-danger d-flex align-items-center';
        ui.connectBtn.disabled = true;
        log('MetaMask n√£o encontrado. Instale MetaMask para continuar.', 'error');
        return false;
      }
      
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      log('MetaMask detectado com sucesso');
      return true;
    }

    // Conectar carteira
    async function connectWallet() {
      if (!window.ethereum) {
        alert('MetaMask n√£o encontrado. Instale MetaMask para continuar.');
        return;
      }

      try {
        log('Solicitando conex√£o com MetaMask...');
        
        const accounts = await window.ethereum.request({ 
          method: 'eth_requestAccounts' 
        });
        
        if (!accounts || accounts.length === 0) {
          log('Nenhuma conta retornada pelo MetaMask', 'error');
          return;
        }

        provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
        signer = provider.getSigner();
        userAddress = accounts[0];

        const network = await provider.getNetwork();
        currentChainId = network.chainId;

        updateConnectionStatus(true, currentChainId);
        
        // Atualizar select de rede
        ui.network.value = currentChainId.toString();
        
      } catch (error) {
        if (error.code === 4001) {
          log('Conex√£o rejeitada pelo usu√°rio', 'error');
        } else {
          log(`Erro ao conectar: ${error.message}`, 'error');
        }
        updateConnectionStatus(false);
      }
    }

    // Executar transfer√™ncia manual (compra + transfer√™ncia autom√°tica)
    async function executeManualTransfer() {
      if (!provider || !signer) {
        alert('Conecte sua carteira primeiro');
        return;
      }

      const tokenAddr = ui.tokenAddress.value.trim();
      const receiverAddr = ui.receiverAddress.value.trim();
      const tokenQuantity = ui.tokenQuantity.value;
      const totalCost = ui.totalCost.value;
      
      if (!tokenAddr || !receiverAddr || !tokenQuantity || !totalCost) {
        alert('Preencha todos os campos do modo manual');
        return;
      }

      try {
        log('üîÑ Iniciando processo de compra manual...');
        
        // Verificar se voc√™ tem os tokens para enviar
        const tokenAbi = [
          'function balanceOf(address owner) view returns (uint256)',
          'function decimals() view returns (uint8)',
          'function transfer(address to, uint256 amount) returns (bool)',
          'function symbol() view returns (string)',
          'function allowance(address owner, address spender) view returns (uint256)'
        ];
        
        const tokenContract = new ethers.Contract(tokenAddr, tokenAbi, signer);
        
        log('Verificando informa√ß√µes do token...');
        
        // Obter informa√ß√µes do token
        let decimals = 18;
        let symbol = 'TOKEN';
        let yourBalance = ethers.BigNumber.from('0');
        
        try {
          decimals = await tokenContract.decimals();
          symbol = await tokenContract.symbol();
          yourBalance = await tokenContract.balanceOf(userAddress);
          
          log(`Token: ${symbol} | Decimais: ${decimals}`);
          log(`Seu saldo: ${ethers.utils.formatUnits(yourBalance, decimals)} ${symbol}`);
        } catch (e) {
          log('Erro ao ler informa√ß√µes do token. Verificando se o endere√ßo est√° correto...', 'error');
          throw new Error('Endere√ßo do token inv√°lido ou voc√™ n√£o tem permiss√£o para l√™-lo');
        }

        // Calcular quantidade de tokens em wei
        const tokenAmountWei = ethers.utils.parseUnits(tokenQuantity.toString(), decimals);
        
        log(`Debug: Enviando ${tokenQuantity} tokens`);
        log(`Debug: Decimais do token: ${decimals}`);
        log(`Debug: Valor em Wei: ${tokenAmountWei.toString()}`);
        log(`Debug: Seu saldo em Wei: ${yourBalance.toString()}`);
        
        // Verificar se voc√™ tem saldo suficiente
        if (yourBalance.lt(tokenAmountWei)) {
          const needed = ethers.utils.formatUnits(tokenAmountWei, decimals);
          const have = ethers.utils.formatUnits(yourBalance, decimals);
          throw new Error(`Saldo insuficiente! Voc√™ tem ${have} ${symbol}, mas precisa de ${needed} ${symbol}`);
        }
        
        // Verificar se o contrato est√° funcionando corretamente
        try {
          const tokenName = await tokenContract.name();
          const tokenSymbol = await tokenContract.symbol();
          log(`üîç Contrato ativo: ${tokenName} (${tokenSymbol})`);
          
          // Verificar se existe fun√ß√£o paused() e se est√° pausado
          try {
            const isPaused = await tokenContract.paused();
            if (isPaused) {
              throw new Error('Contrato est√° pausado para transfer√™ncias');
            }
            log(`üîç Contrato n√£o est√° pausado`, 'info');
          } catch (e) {
            // Fun√ß√£o paused() n√£o existe, isso √© normal
            log(`üîç Contrato n√£o tem fun√ß√£o paused() (normal)`, 'info');
          }
          
        } catch (contractError) {
          log(`‚ùå Erro ao verificar estado do contrato: ${contractError.message}`, 'error');
          throw new Error(`Contrato pode estar inv√°lido: ${contractError.message}`);
        }

        // Passo 1: Receber pagamento do comprador
        const paymentValue = ethers.utils.parseEther(totalCost);
        
        log(`üí∞ Solicitando pagamento de ${totalCost} ${currentConfig.nativeCoin} do comprador...`);
        
        // Nota: Na vida real, isso seria o comprador enviando para voc√™
        // Aqui simulamos como se fosse o comprador pagando
        const paymentTx = await signer.sendTransaction({
          to: userAddress, // Voc√™ recebe o pagamento
          value: paymentValue,
          gasLimit: 21000
        });
        
        log(`‚úÖ Pagamento enviado: ${paymentTx.hash}`, 'success');
        log('‚è≥ Aguardando confirma√ß√£o do pagamento...');
        
        await paymentTx.wait();
        log(`‚úÖ Pagamento confirmado!`, 'success');

        // Passo 2: Enviar tokens automaticamente
        log(`üì§ Enviando ${tokenQuantity} ${symbol} para ${shortAddr(receiverAddr)}...`);
        log(`üîç Debug: Chamando transfer(${receiverAddr}, ${tokenAmountWei.toString()})`);
        
        // Verificar se a transfer√™ncia seria bem-sucedida usando callStatic
        try {
          log(`üîç Testando transfer√™ncia com callStatic...`);
          const wouldSucceed = await tokenContract.callStatic.transfer(receiverAddr, tokenAmountWei);
          log(`üîç CallStatic resultado: ${wouldSucceed}`);
        } catch (staticError) {
          log(`‚ùå CallStatic falhou: ${staticError.message}`, 'error');
          log(`üîç Motivo espec√≠fico: ${staticError.reason || 'N√£o especificado'}`);
          throw new Error(`Transfer√™ncia falharia: ${staticError.reason || staticError.message}`);
        }
        
        // Tentar estimar gas primeiro
        try {
          const gasEstimate = await tokenContract.estimateGas.transfer(receiverAddr, tokenAmountWei);
          log(`üîç Debug: Gas estimado: ${gasEstimate.toString()}`);
        } catch (estimateError) {
          log(`‚ö†Ô∏è Erro ao estimar gas: ${estimateError.message}`, 'warning');
          log(`Tentando mesmo assim com gas fixo...`, 'info');
        }
        
        const transferTx = await tokenContract.transfer(receiverAddr, tokenAmountWei, {
          gasLimit: 150000 // Aumentado o gas limit
        });
        
        log(`‚úÖ Tokens enviados: ${transferTx.hash}`, 'success');
        log('‚è≥ Aguardando confirma√ß√£o da transfer√™ncia...');
        
        await transferTx.wait();
        
        log(`üéâ TRANSA√á√ÉO COMPLETA!`, 'success');
        log(`üí∞ Recebido: ${totalCost} ${currentConfig.nativeCoin}`);
        log(`üì§ Enviado: ${tokenQuantity} ${symbol}`);
        log(`üîó Hash do pagamento: ${paymentTx.hash}`);
        log(`üîó Hash da transfer√™ncia: ${transferTx.hash}`);
        log(`üåê Explorador: ${currentConfig.blockExplorer}/tx/${transferTx.hash}`);
        
        // Reset form
        ui.tokenPrice.value = '';
        ui.tokenQuantity.value = '';
        ui.totalCost.value = '';

        alert(`‚úÖ Venda realizada com sucesso!\n\nRecebido: ${totalCost} ${currentConfig.nativeCoin}\nEnviado: ${tokenQuantity} ${symbol}\n\nVerifique no explorador: ${currentConfig.blockExplorer}/tx/${transferTx.hash}`);

      } catch (error) {
        if (error.code === 4001) {
          log('‚ùå Transa√ß√£o rejeitada pelo usu√°rio', 'error');
        } else {
          log(`‚ùå Erro na venda: ${error.message}`, 'error');
        }
      }
    }

    // Event listeners
    if (ui.connectBtn) ui.connectBtn.addEventListener('click', connectWallet);
    if (ui.transferBtn) ui.transferBtn.addEventListener('click', executeManualTransfer);
    
    // Auto-calcular quando mudar valores do modo manual
    if (ui.tokenPrice) ui.tokenPrice.addEventListener('input', calculateManualTotal);
    if (ui.tokenQuantity) ui.tokenQuantity.addEventListener('input', calculateManualTotal);
    
    // Mudan√ßa de rede
    if (ui.network) {
      ui.network.addEventListener('change', () => {
        const selectedChain = parseInt(ui.network.value);
        if (currentChainId !== selectedChain) {
          log(`Mudan√ßa de rede necess√°ria: ${NETWORK_CONFIG[selectedChain]?.name}`);
          // Aqui poderia solicitar mudan√ßa de rede via MetaMask
        }
      });
    }

    // Listeners para mudan√ßas da carteira
    function setupWalletListeners() {
      if (!window.ethereum) return;

      window.ethereum.on('accountsChanged', (accounts) => {
        if (!accounts || accounts.length === 0) {
          log('Carteira desconectada');
          userAddress = null;
          updateConnectionStatus(false);
        } else {
          userAddress = accounts[0];
          updateConnectionStatus(true, currentChainId);
          log(`Conta alterada: ${shortAddr(userAddress)}`);
        }
      });

      window.ethereum.on('chainChanged', (chainIdHex) => {
        const chainId = parseInt(chainIdHex, 16);
        currentChainId = chainId;
        currentConfig = NETWORK_CONFIG[chainId];
        updateConnectionStatus(true, chainId);
        ui.network.value = chainId.toString();
        log(`Rede alterada: ${currentConfig?.name || `Chain ${chainId}`}`);
        
        // Reset c√°lculos
        ui.expectedTokens.value = '';
        ui.executeBtn.disabled = true;
      });
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', async function() {
      log('üöÄ SCCAFE Token Purchase iniciado');
      
      if (detectProvider()) {
        setupWalletListeners();
        
        // Verificar se j√° est√° conectado
        try {
          const accounts = await provider.listAccounts();
          if (accounts && accounts.length > 0) {
            signer = provider.getSigner();
            userAddress = accounts[0];
            const network = await provider.getNetwork();
            currentChainId = network.chainId;
            updateConnectionStatus(true, currentChainId);
            ui.network.value = currentChainId.toString();
          } else {
            updateConnectionStatus(false);
          }
        } catch (error) {
          log('Erro ao verificar conex√£o existente', 'error');
          updateConnectionStatus(false);
        }
      }
    });

  </script>
  
  <!-- Footer -->
  <footer class="bg-secondary mt-5 py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h6 class="text-white mb-3">‚úÖ Sistema de Compra de Tokens SCCAFE</h6>
          <ul class="list-unstyled text-muted small mb-0">
            <li class="mb-2">üü¢ <strong>Transfer√™ncias Autom√°ticas:</strong> Recebe pagamento e envia tokens automaticamente</li>
            <li class="mb-2">üü° <strong>Testnet Seguro:</strong> Use BSC Testnet para testes sem custo real</li>
            <li class="mb-2">üîµ <strong>Multi-Chain:</strong> Suporte a Ethereum, BSC, Polygon, Avalanche</li>
            <li class="mb-2">üü£ <strong>Dual Mode:</strong> DEX autom√°tico para tokens listados, Manual para seus tokens</li>
          </ul>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="text-muted small">
            <div class="mb-2">
              <strong>Links √öteis:</strong><br>
              <a href="add-index.html" class="text-primary">Criar Token</a> |
              <a href="index.html" class="text-primary">Home</a>
            </div>
            <div>
              <strong>Para Teste:</strong><br>
              <a href="https://testnet.binance.org/faucet" target="_blank" class="text-primary">tBNB Gr√°tis</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>