<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compra Direta TKN - SCCAFE</title>

<!-- Favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="imgs/sccafe-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="imgs/sccafe-32x32.png">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- SCCAFE Global CSS Unificado -->
<link href="styles/globals.css" rel="stylesheet">

<!-- Ethers.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
<!-- Header -->
<header data-component="header"></header>

<!-- Main Content -->
<main class="token-creator-main py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-xl-10 col-lg-11">
        <div class="creator-card bg-dark border border-primary rounded-4 p-4 shadow-lg">
          
          <!-- Header -->
          <div class="creator-header border-bottom border-secondary pb-4 mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h1 class="display-6 fw-bold text-white mb-2">
                  <i class="bi bi-cart-plus text-primary me-2"></i>Compra Direta TKN
                </h1>
                <p class="text-secondary mb-0">Adquira tokens TKN usando BNB na BSC Testnet</p>
              </div>
              <div class="d-none d-md-block">
                <img src="imgs/sccafe.png" alt="SCCAFE" style="height: 60px;">
              </div>
            </div>
          </div>

          <!-- Se√ß√£o 1: Teste de Conex√£o -->
          <div class="card bg-dark border-warning shadow mb-4">
            <div class="card-header bg-warning text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-wifi me-2"></i>1. Teste de Conex√£o MetaMask
              </h5>
            </div>
            <div class="card-body">
              <p class="text-secondary mb-3">Primeiro, vamos verificar se sua carteira est√° funcionando</p>
              <div class="row g-3">
                <div class="col-md-8">
                  <p id="status" class="mb-2 text-white">Clique em "Testar Conex√£o" para verificar</p>
                </div>
                <div class="col-md-4">
                  <button id="testConnection" class="btn btn-warning w-100 fw-bold">
                    <i class="bi bi-wifi me-2"></i>TESTAR CONEX√ÉO
                  </button>
                </div>
              </div>
              <!-- Resultado do teste -->
              <div id="connectionResult" class="mt-3" style="display: none;">
                <div class="alert alert-info mb-0">
                  <ul id="connectionErrors" class="mb-0"></ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o 2: Verifica√ß√£o do Contrato -->
          <div class="card bg-dark border-info shadow mb-4">
            <div class="card-header bg-info text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-search me-2"></i>2. Verifica√ß√£o do Contrato
              </h5>
            </div>
            <div class="card-body">
              <p class="text-secondary mb-3">Verificar informa√ß√µes do token e disponibilidade</p>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <small class="text-muted">Nome do Token</small>
                  <p id="tokenName" class="fw-bold mb-2">Clique em verificar</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted">S√≠mbolo</small>
                  <p id="tokenSymbol" class="fw-bold mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted">Pre√ßo por Token</small>
                  <p id="tokenPriceDisplay" class="fw-bold text-primary mb-2">0.003 BNB</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted">Dispon√≠vel para Compra</small>
                  <p id="tokenBalance" class="fw-bold text-success mb-2">-</p>
                </div>
              </div>
              <button id="checkContract" class="btn btn-info fw-bold">
                <i class="bi bi-search me-2"></i>VERIFICAR CONTRATO
              </button>
              <!-- Resultado da verifica√ß√£o -->
              <div id="contractResult" class="mt-3" style="display: none;">
                <div class="alert alert-success mb-0">
                  <ul id="contractErrors" class="mb-0"></ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o 3: Calculadora e Compra -->
          <div class="card bg-dark border-success shadow mb-4">
            <div class="card-header bg-success text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-calculator me-2"></i>3. Calculadora e Compra
              </h5>
            </div>
            <div class="card-body">
              <p class="text-secondary mb-3">Digite a quantidade e realize a compra</p>
              <div class="row g-3 mb-3">
                <div class="col-md-8">
                  <label for="tokenAmount" class="form-label text-white">Quantidade de Tokens</label>
                  <input type="number" id="tokenAmount" class="form-control bg-dark text-white border-secondary" 
                         placeholder="Ex: 100" min="1">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button id="buyButton" class="btn btn-success w-100 btn-lg fw-bold">
                    <i class="bi bi-cart-check me-2"></i>COMPRAR
                  </button>
                </div>
              </div>
              
              <!-- Calculadora (aparece quando digita) -->
              <div id="calculationDisplay" class="alert alert-primary" style="display: none;">
                <h6 class="text-dark mb-2">üí∞ C√°lculo da Compra</h6>
                <div class="row g-2">
                  <div class="col-md-4">
                    <small class="text-dark">Quantidade</small>
                    <p id="calcTokens" class="fw-bold text-dark mb-1">0</p>
                  </div>
                  <div class="col-md-4">
                    <small class="text-dark">Total a Pagar</small>
                    <p id="calcTotal" class="fw-bold text-dark mb-1">0 BNB</p>
                  </div>
                  <div class="col-md-4">
                    <small class="text-dark">Status</small>
                    <p id="availabilityStatus" class="fw-bold mb-1">-</p>
                  </div>
                </div>
              </div>
              
              <!-- Resultado da compra -->
              <div id="purchaseResult" class="mt-3" style="display: none;">
                <div class="alert alert-warning mb-0">
                  <ul id="purchaseErrors" class="mb-0"></ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o 4: Detalhes da Transa√ß√£o -->
          <div class="card bg-dark border-primary shadow mb-4" id="transactionDetails" style="display: none;">
            <div class="card-header bg-primary text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-receipt me-2"></i>4. Detalhes da Transa√ß√£o
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <small class="text-muted">Hash da Transa√ß√£o</small>
                  <p id="txHash" class="fw-bold font-monospace small text-break text-primary">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted">Tokens Recebidos</small>
                  <p id="txTokensReceived" class="fw-bold text-success">-</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Valor Enviado</small>
                  <p id="txValue" class="fw-bold text-white">- BNB</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Taxa de Gas</small>
                  <p id="txGasPrice" class="fw-bold text-white">- BNB</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Total Pago</small>
                  <p id="txTotalCost" class="fw-bold text-warning">- BNB</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer data-component="footer"></footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- SCCAFE Shared Modules (carregados antes do m√≥dulo espec√≠fico) -->
<script src="js/shared/metamask-connector.js"></script>
<script src="js/shared/common-utils.js"></script>
<script src="js/shared/token-global.js"></script>

<!-- Template Loader -->
<script src="js/template-loader.js"></script>

<!-- M√≥dulo de Compra de Tokens -->
<script src="js/compra-token.js"></script>

</body>
</html>
const tokenPrice = ethers.utils.parseEther("0.003"); // Pre√ßo inicial em tBNB por token
const tokenPriceFormatted = "0.003"; // Para exibi√ß√£o

// ABI b√°sico do ERC-20 para verificar saldo
const tokenABI = [
    "function balanceOf(address owner) view returns (uint256)",
    "function totalSupply() view returns (uint256)",
    "function name() view returns (string)",
    "function symbol() view returns (string)"
];

let provider;
let signer;

// Fun√ß√µes para manipular lista de erros por se√ß√£o
function addConnectionError(msg) {
    const ul = document.getElementById("connectionErrors");
    const container = document.getElementById("connectionResult");
    const li = document.createElement("li");
    li.textContent = msg;
    li.className = "text-dark mb-1";
    ul.appendChild(li);
    container.style.display = "block";
}

function addContractError(msg) {
    const ul = document.getElementById("contractErrors");
    const container = document.getElementById("contractResult");
    const li = document.createElement("li");
    li.textContent = msg;
    li.className = "text-dark mb-1";
    ul.appendChild(li);
    container.style.display = "block";
}

function addPurchaseError(msg) {
    const ul = document.getElementById("purchaseErrors");
    const container = document.getElementById("purchaseResult");
    const li = document.createElement("li");
    li.textContent = msg;
    li.className = "text-dark mb-1";
    ul.appendChild(li);
    container.style.display = "block";
}

function clearConnectionErrors() {
    const ul = document.getElementById("connectionErrors");
    const container = document.getElementById("connectionResult");
    if (ul) ul.innerHTML = "";
    if (container) container.style.display = "none";
}

function clearContractErrors() {
    const ul = document.getElementById("contractErrors");
    const container = document.getElementById("contractResult");
    if (ul) ul.innerHTML = "";
    if (container) container.style.display = "none";
}

function clearPurchaseErrors() {
    const ul = document.getElementById("purchaseErrors");
    const container = document.getElementById("purchaseResult");
    if (ul) ul.innerHTML = "";
    if (container) container.style.display = "none";
}

// Fun√ß√£o para calcular total em tempo real
function calculateTotal() {
    const amount = document.getElementById("tokenAmount").value;
    const calcDiv = document.getElementById("calculationDisplay");
    
    if (amount && amount > 0) {
        const total = parseFloat(amount) * parseFloat(tokenPriceFormatted);
        
        const calcTokensEl = document.getElementById("calcTokens");
        const calcTotalEl = document.getElementById("calcTotal");
        const statusEl = document.getElementById("availabilityStatus");
        
        if (calcTokensEl) calcTokensEl.textContent = amount;
        if (calcTotalEl) calcTotalEl.textContent = total.toFixed(6) + " BNB";
        
        // Verificar disponibilidade
        const availableText = document.getElementById("tokenBalance").textContent;
        if (availableText !== "-" && availableText !== "Clique em verificar" && !isNaN(parseFloat(availableText))) {
            const available = parseFloat(availableText);
            
            if (statusEl) {
                if (parseFloat(amount) <= available) {
                    statusEl.textContent = "‚úÖ Dispon√≠vel";
                    statusEl.className = "fw-bold text-success";
                } else {
                    statusEl.textContent = "‚ùå Indispon√≠vel";
                    statusEl.className = "fw-bold text-danger";
                }
            }
        } else {
            if (statusEl) {
                statusEl.textContent = "‚è≥ Verificar contrato";
                statusEl.className = "fw-bold text-warning";
            }
        }
        
        if (calcDiv) calcDiv.style.display = "block";
    } else {
        if (calcDiv) calcDiv.style.display = "none";
    }
}

// Atualizar displays iniciais
document.addEventListener('DOMContentLoaded', function() {
    const priceEl = document.getElementById("tokenPriceDisplay");
    if (priceEl) priceEl.textContent = tokenPriceFormatted + " BNB";
});

async function connectWallet() {
    if (window.ethereum) {
        try {
            // Verificar conectividade b√°sica primeiro
            await window.ethereum.request({ method: 'eth_chainId' });
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            
            // Verificar se consegue obter o endere√ßo
            const address = await signer.getAddress();
            document.getElementById("status").innerText = "‚úÖ Carteira conectada: " + address;
            
            // Verificar rede
            const network = await provider.getNetwork();
            if (network.chainId !== 97) {
                addConnectionError("‚ö†Ô∏è Voc√™ est√° na rede " + network.name + " (chainId: " + network.chainId + ")");
                addConnectionError("Por favor, mude para BSC Testnet (chainId: 97)");
            } else {
                addConnectionError("‚úÖ Conectado √† BSC Testnet");
            }
            
        } catch (err) {
            addConnectionError("Erro ao conectar carteira: " + err.message);
            throw err;
        }
    } else {
        alert("Instale a Metamask ou outro provedor Web3!");
    }
}

async function buyTokens() {
    clearPurchaseErrors();
    const amountInput = document.getElementById("tokenAmount").value;
    if (!amountInput || amountInput <= 0) {
        addPurchaseError("Informe a quantidade de tokens.");
        return;
    }

    if (!signer) {
        addPurchaseError("Carteira n√£o conectada.");
        return;
    }

    // Verificar se h√° tokens suficientes dispon√≠veis
    const availableText = document.getElementById("tokenBalance").textContent;
    if (availableText !== "-" && availableText !== "Clique em verificar" && !isNaN(parseFloat(availableText))) {
        const available = parseFloat(availableText);
        if (parseFloat(amountInput) > available) {
            addPurchaseError(`‚ùå Tokens insuficientes! Dispon√≠vel: ${available.toLocaleString()}, Solicitado: ${amountInput}`);
            return;
        }
    }

    let amountBNB, amountWei;
    try {
        amountBNB = tokenPrice.mul(ethers.BigNumber.from(amountInput));
        amountWei = amountBNB;
        addPurchaseError(`üí∞ Valor calculado: ${ethers.utils.formatEther(amountWei)} BNB para ${amountInput} tokens`);
    } catch (err) {
        addPurchaseError("Erro ao calcular valor em BNB: " + err.message);
        return;
    }

    try {
        document.getElementById("status").innerText = "Enviando transa√ß√£o...";
        addPurchaseError("üì§ Preparando transa√ß√£o...");
        
        // Transa√ß√£o direta sem verifica√ß√µes que causam erro RPC
        const tx = await signer.sendTransaction({
            to: contractAddress,
            value: amountWei,
            gasLimit: 150000 // Gas um pouco maior para seguran√ßa
        });
        
        document.getElementById("status").innerText = "Transa√ß√£o enviada. Aguarde confirma√ß√£o...";
        addPurchaseError("‚è≥ Transa√ß√£o enviada, aguardando confirma√ß√£o...");
        
        const receipt = await tx.wait();
        
        // Mostrar detalhes da transa√ß√£o
        document.getElementById("txHash").textContent = tx.hash;
        document.getElementById("txValue").textContent = ethers.utils.formatEther(amountWei);
        
        // Calcular taxa de gas
        const gasFee = receipt.gasUsed.mul(receipt.effectiveGasPrice || tx.gasPrice);
        document.getElementById("txGasPrice").textContent = ethers.utils.formatEther(gasFee);
        
        // Calcular total (aproximado)
        const totalApprox = amountWei.add(gasFee);
        document.getElementById("txTotalCost").textContent = ethers.utils.formatEther(totalApprox);
        document.getElementById("txTokensReceived").textContent = amountInput + " TKN";
        
        // Mostrar div de detalhes
        document.getElementById("transactionDetails").style.display = "block";
        
        document.getElementById("status").innerText = `‚úÖ Compra conclu√≠da! Hash: ${tx.hash}`;
        addPurchaseError(`‚úÖ Transa√ß√£o confirmada no bloco ${receipt.blockNumber}`);
        addPurchaseError(`üéâ Voc√™ comprou ${amountInput} tokens!`);
        
        // Atualizar saldo do contrato ap√≥s a transa√ß√£o
        setTimeout(() => {
            addPurchaseError("üîÑ Atualizando informa√ß√µes do contrato...");
            checkContract();
        }, 3000);
        
    } catch (err) {
        addPurchaseError("‚ùå Erro na transa√ß√£o: " + err.message);
        if (err.reason) {
            addPurchaseError("Motivo: " + err.reason);
        }
        if (err.code) {
            addPurchaseError("C√≥digo do erro: " + err.code);
        }
        
        // Dicas de solu√ß√£o
        if (err.message.includes("insufficient funds")) {
            addPurchaseError("üí° Dica: Voc√™ n√£o tem BNB suficiente para a transa√ß√£o + taxas de gas.");
        }
        if (err.message.includes("execution reverted")) {
            addPurchaseError("üí° Dica: O contrato rejeitou a transa√ß√£o. Verifique se h√° tokens dispon√≠veis.");
        }
    }
}

async function checkContract() {
    clearContractErrors();
    
    // Tentar com um provider p√∫blico da BSC Testnet
    const publicProvider = new ethers.providers.JsonRpcProvider("https://data-seed-prebsc-1-s1.binance.org:8545/");
    
    try {
        addContractError("üîç Verificando contrato...");
        
        // Verificar se existe c√≥digo no endere√ßo
        const code = await publicProvider.getCode(contractAddress);
        
        if (code === '0x') {
            addContractError("‚ùå PROBLEMA: N√£o existe contrato neste endere√ßo!");
            addContractError("O endere√ßo pode estar incorreto ou o contrato n√£o foi deployed na BSC Testnet.");
            return;
        } else {
            addContractError("‚úÖ Contrato encontrado no endere√ßo.");
        }
        
        // Verificar saldo do contrato em BNB
        const balance = await publicProvider.getBalance(contractAddress);
        addContractError(`üí∞ Saldo BNB do contrato: ${ethers.utils.formatEther(balance)} BNB`);
        
        // Verificar conectividade da rede
        const blockNumber = await publicProvider.getBlockNumber();
        addContractError(`üì° Bloco atual BSC Testnet: ${blockNumber}`);
        
        // Tentar acessar as fun√ß√µes do token ERC-20
        try {
            const tokenContract = new ethers.Contract(contractAddress, tokenABI, publicProvider);
            
            // Obter informa√ß√µes b√°sicas do token
            const name = await tokenContract.name();
            const symbol = await tokenContract.symbol();
            const totalSupply = await tokenContract.totalSupply();
            const contractTokenBalance = await tokenContract.balanceOf(contractAddress);
            
            // Atualizar interface
            document.getElementById("tokenName").textContent = name;
            document.getElementById("tokenSymbol").textContent = symbol;
            document.getElementById("tokenBalance").textContent = ethers.utils.formatUnits(contractTokenBalance, tokenDecimals);
            
            addContractError(`‚úÖ Token: ${name} (${symbol})`);
            addContractError(`üìä Total Supply: ${ethers.utils.formatUnits(totalSupply, tokenDecimals)} ${symbol}`);
            addContractError(`ü™ô Tokens dispon√≠veis no contrato: ${ethers.utils.formatUnits(contractTokenBalance, tokenDecimals)} ${symbol}`);
            
            // Verificar se tem tokens suficientes para venda
            if (contractTokenBalance.gt(0)) {
                addContractError("‚úÖ Contrato tem tokens dispon√≠veis para venda.");
            } else {
                addContractError("‚ö†Ô∏è ATEN√á√ÉO: Contrato n√£o tem tokens para venda!");
            }
            
        } catch (tokenErr) {
            addContractError("‚ö†Ô∏è N√£o foi poss√≠vel acessar fun√ß√µes ERC-20: " + tokenErr.message);
            addContractError("O contrato pode n√£o ser um token ERC-20 padr√£o.");
            
            // Resetar displays
            document.getElementById("tokenName").textContent = "N/A";
            document.getElementById("tokenSymbol").textContent = "N/A";
            document.getElementById("tokenBalance").textContent = "N/A";
        }
        
    } catch (err) {
        addContractError("‚ùå Erro ao verificar contrato: " + err.message);
        addContractError("üí° Pode ser um problema de conectividade com a BSC Testnet.");
    }
}

async function testConnection() {
    clearConnectionErrors();
    
    try {
        if (!window.ethereum) {
            addConnectionError("‚ùå MetaMask n√£o instalado!");
            return;
        }
        
        addConnectionError("üîç Testando conectividade...");
        
        // Teste b√°sico - obter chainId
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        addConnectionError(`‚úÖ MetaMask respondeu! ChainId: ${parseInt(chainId, 16)}`);
        
        // Verificar se √© BSC Testnet
        if (parseInt(chainId, 16) === 97) {
            addConnectionError("‚úÖ Conectado √† BSC Testnet (correto)");
        } else {
            addConnectionError(`‚ö†Ô∏è Voc√™ est√° na rede ${parseInt(chainId, 16)}, mude para BSC Testnet (97)`);
        }
        
        // Teste de contas
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (accounts.length > 0) {
            addConnectionError(`‚úÖ Conta conectada: ${accounts[0]}`);
        }
        
        addConnectionError("üéâ MetaMask est√° funcionando! Pode prosseguir para verificar o contrato.");
        
    } catch (err) {
        addConnectionError("‚ùå Erro de conectividade: " + err.message);
        addConnectionError("üí° Poss√≠veis solu√ß√µes:");
        addConnectionError("‚Ä¢ Reinicie o MetaMask");
        addConnectionError("‚Ä¢ Mude para BSC Testnet manualmente");
        addConnectionError("‚Ä¢ Verifique sua conex√£o com internet");
    }
}

// Eventos dos bot√µes
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("checkContract").addEventListener("click", checkContract);
    document.getElementById("testConnection").addEventListener("click", testConnection);
    document.getElementById("buyButton").addEventListener("click", async () => {
        clearPurchaseErrors();
        try {
            if (!signer) await connectWallet();
            await buyTokens();
        } catch (err) {
            addPurchaseError("Erro inesperado: " + err.message);
        }
    });
});

// Fun√ß√£o para calcular total em tempo real
function calculateTotal() {
    const amount = document.getElementById("tokenAmount").value;
    const calcDiv = document.getElementById("calculationDisplay");
    
    if (amount && amount > 0) {
        const total = parseFloat(amount) * parseFloat(tokenPriceFormatted);
        
        document.getElementById("calcTokens").textContent = amount;
        document.getElementById("calcPrice").textContent = tokenPriceFormatted + " BNB";
        document.getElementById("calcTotal").textContent = total.toFixed(6) + " BNB";
        
        // Verificar disponibilidade
        const availableText = document.getElementById("tokenBalance").textContent;
        if (availableText !== "Carregando..." && availableText !== "N/A") {
            const available = parseFloat(availableText);
            
            const statusEl = document.getElementById("availabilityStatus");
            if (parseFloat(amount) <= available) {
                statusEl.textContent = "‚úÖ Dispon√≠vel";
                statusEl.className = "fw-bold text-success";
            } else {
                statusEl.textContent = "‚ùå Indispon√≠vel";
                statusEl.className = "fw-bold text-danger";
            }
        } else {
            document.getElementById("availabilityStatus").textContent = "‚è≥ Verificando...";
            document.getElementById("availabilityStatus").className = "fw-bold text-warning";
        }
        
        calcDiv.style.display = "block";
    } else {
        calcDiv.style.display = "none";
    }
}

// Atualizar displays iniciais
document.getElementById("tokenPriceDisplay").textContent = tokenPriceFormatted + " BNB";

async function connectWallet() {
    if (window.ethereum) {
        try {
            // Verificar conectividade b√°sica primeiro
            await window.ethereum.request({ method: 'eth_chainId' });
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            
            // Verificar se consegue obter o endere√ßo
            const address = await signer.getAddress();
            document.getElementById("status").innerText = "Carteira conectada: " + address;
            
            // Verificar rede
            const network = await provider.getNetwork();
            if (network.chainId !== 97) {
                addConnectionError("‚ö†Ô∏è Voc√™ est√° na rede " + network.name + " (chainId: " + network.chainId + ")");
                addConnectionError("Por favor, mude para BSC Testnet (chainId: 97)");
            } else {
                addConnectionError("‚úÖ Conectado √† BSC Testnet");
            }
            
        } catch (err) {
            addConnectionError("Erro ao conectar carteira: " + err.message);
            throw err;
        }
    } else {
        alert("Instale a Metamask ou outro provedor Web3!");
    }
}

async function buyTokens() {
    const amountInput = document.getElementById("tokenAmount").value;
    if (!amountInput || amountInput <= 0) {
        addPurchaseError("Informe a quantidade de tokens.");
        return;
    }

    if (!signer) {
        addPurchaseError("Carteira n√£o conectada.");
        return;
    }

    // Verificar se h√° tokens suficientes dispon√≠veis
    const availableText = document.getElementById("tokenBalance").textContent;
    if (availableText !== "Carregando..." && availableText !== "N/A") {
        const available = parseFloat(availableText);
        if (parseFloat(amountInput) > available) {
            addPurchaseError(`‚ùå Tokens insuficientes! Dispon√≠vel: ${available.toLocaleString()}, Solicitado: ${amountInput}`);
            return;
        }
    }

    let amountBNB, amountWei;
    try {
        amountBNB = tokenPrice.mul(ethers.BigNumber.from(amountInput));
        amountWei = amountBNB;
        addPurchaseError(`üí∞ Valor calculado: ${ethers.utils.formatEther(amountWei)} BNB para ${amountInput} tokens`);
    } catch (err) {
        addPurchaseError("Erro ao calcular valor em BNB: " + err.message);
        return;
    }

    try {
        document.getElementById("status").innerText = "Enviando transa√ß√£o...";
        addPurchaseError("üì§ Preparando transa√ß√£o...");
        
        // Transa√ß√£o direta sem verifica√ß√µes que causam erro RPC
        const tx = await signer.sendTransaction({
            to: contractAddress,
            value: amountWei,
            gasLimit: 150000 // Gas um pouco maior para seguran√ßa
        });
        
        document.getElementById("status").innerText = "Transa√ß√£o enviada. Aguarde confirma√ß√£o...";
        addPurchaseError("‚è≥ Transa√ß√£o enviada, aguardando confirma√ß√£o...");
        
        const receipt = await tx.wait();
        
        // Mostrar detalhes b√°sicos da transa√ß√£o
        document.getElementById("txHash").textContent = tx.hash;
        document.getElementById("txValue").textContent = ethers.utils.formatEther(amountWei);
        document.getElementById("txGas").textContent = receipt.gasUsed.toString();
        
        // Calcular taxa de gas
        const gasFee = receipt.gasUsed.mul(receipt.effectiveGasPrice || tx.gasPrice);
        document.getElementById("txGasPrice").textContent = ethers.utils.formatEther(gasFee);
        
        // Calcular total (aproximado)
        const totalApprox = amountWei.add(gasFee);
        document.getElementById("txTotalCost").textContent = ethers.utils.formatEther(totalApprox);
        document.getElementById("txToContract").textContent = ethers.utils.formatEther(amountWei);
        document.getElementById("txNetworkFee").textContent = ethers.utils.formatEther(gasFee);
        document.getElementById("txTokensReceived").textContent = amountInput;
        
        // Mostrar div de detalhes
        document.getElementById("transactionDetails").style.display = "block";
        
        document.getElementById("status").innerText = `‚úÖ Compra conclu√≠da! Hash: ${tx.hash}`;
        addPurchaseError(`‚úÖ Transa√ß√£o confirmada no bloco ${receipt.blockNumber}`);
        addPurchaseError(`üéâ Voc√™ comprou ${amountInput} tokens!`);
        
        // Atualizar saldo do contrato ap√≥s a transa√ß√£o
        setTimeout(() => {
            addPurchaseError("üîÑ Atualizando informa√ß√µes do contrato...");
            checkContract();
        }, 3000);
        
    } catch (err) {
        addPurchaseError("‚ùå Erro na transa√ß√£o: " + err.message);
        if (err.reason) {
            addPurchaseError("Motivo: " + err.reason);
        }
        if (err.code) {
            addPurchaseError("C√≥digo do erro: " + err.code);
        }
        
        // Dicas de solu√ß√£o
        if (err.message.includes("insufficient funds")) {
            addPurchaseError("üí° Dica: Voc√™ n√£o tem BNB suficiente para a transa√ß√£o + taxas de gas.");
        }
        if (err.message.includes("execution reverted")) {
            addPurchaseError("üí° Dica: O contrato rejeitou a transa√ß√£o. Verifique se h√° tokens dispon√≠veis.");
        }
    }
}

async function checkContract() {
    
    // Tentar com um provider p√∫blico da BSC Testnet
    const publicProvider = new ethers.providers.JsonRpcProvider("https://data-seed-prebsc-1-s1.binance.org:8545/");
    
    try {
        addContractError("üîç Verificando contrato...");
        
        // Verificar se existe c√≥digo no endere√ßo
        const code = await publicProvider.getCode(contractAddress);
        
        if (code === '0x') {
            addContractError("‚ùå PROBLEMA: N√£o existe contrato neste endere√ßo!");
            addContractError("O endere√ßo pode estar incorreto ou o contrato n√£o foi deployed na BSC Testnet.");
            return;
        } else {
            addContractError("‚úÖ Contrato encontrado no endere√ßo.");
        }
        
        // Verificar saldo do contrato em BNB
        const balance = await publicProvider.getBalance(contractAddress);
        addContractError(`üí∞ Saldo BNB do contrato: ${ethers.utils.formatEther(balance)} BNB`);
        
        // Verificar conectividade da rede
        const blockNumber = await publicProvider.getBlockNumber();
        addContractError(`üì° Bloco atual BSC Testnet: ${blockNumber}`);
        
        // Tentar acessar as fun√ß√µes do token ERC-20
        try {
            const tokenContract = new ethers.Contract(contractAddress, tokenABI, publicProvider);
            
            // Obter informa√ß√µes b√°sicas do token
            const name = await tokenContract.name();
            const symbol = await tokenContract.symbol();
            const totalSupply = await tokenContract.totalSupply();
            const contractTokenBalance = await tokenContract.balanceOf(contractAddress);
            
            // Atualizar interface
            document.getElementById("tokenName").textContent = name;
            document.getElementById("tokenSymbol").textContent = symbol;
            document.getElementById("totalSupply").textContent = ethers.utils.formatUnits(totalSupply, tokenDecimals);
            document.getElementById("tokenBalance").textContent = ethers.utils.formatUnits(contractTokenBalance, tokenDecimals);
            
            addContractError(`‚úÖ Token: ${name} (${symbol})`);
            addContractError(`üìä Total Supply: ${ethers.utils.formatUnits(totalSupply, tokenDecimals)} ${symbol}`);
            addContractError(`ü™ô Tokens dispon√≠veis no contrato: ${ethers.utils.formatUnits(contractTokenBalance, tokenDecimals)} ${symbol}`);
            
            // Verificar se tem tokens suficientes para venda
            if (contractTokenBalance.gt(0)) {
                addContractError("‚úÖ Contrato tem tokens dispon√≠veis para venda.");
            } else {
                addContractError("‚ö†Ô∏è ATEN√á√ÉO: Contrato n√£o tem tokens para venda!");
            }
            
        } catch (tokenErr) {
            addContractError("‚ö†Ô∏è N√£o foi poss√≠vel acessar fun√ß√µes ERC-20: " + tokenErr.message);
            addContractError("O contrato pode n√£o ser um token ERC-20 padr√£o.");
            
            // Resetar displays
            document.getElementById("tokenName").textContent = "N/A";
            document.getElementById("tokenSymbol").textContent = "N/A";
            document.getElementById("totalSupply").textContent = "N/A";
            document.getElementById("tokenBalance").textContent = "N/A";
        }
        
    } catch (err) {
        addContractError("‚ùå Erro ao verificar contrato: " + err.message);
        addContractError("üí° Pode ser um problema de conectividade com a BSC Testnet.");
    }
}

async function testConnection() {
    
    try {
        if (!window.ethereum) {
            addConnectionError("‚ùå MetaMask n√£o instalado!");
            return;
        }
        
        addConnectionError("üîç Testando conectividade...");
        
        // Teste b√°sico - obter chainId
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        addConnectionError(`‚úÖ MetaMask respondeu! ChainId: ${parseInt(chainId, 16)}`);
        
        // Verificar se √© BSC Testnet
        if (parseInt(chainId, 16) === 97) {
            addConnectionError("‚úÖ Conectado √† BSC Testnet (correto)");
        } else {
            addConnectionError(`‚ö†Ô∏è Voc√™ est√° na rede ${parseInt(chainId, 16)}, mude para BSC Testnet (97)`);
        }
        
        // Teste de contas
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (accounts.length > 0) {
            addConnectionError(`‚úÖ Conta conectada: ${accounts[0]}`);
        }
        
        addConnectionError("üéâ MetaMask est√° funcionando! Pode tentar comprar tokens.");
        
    } catch (err) {
        addConnectionError("‚ùå Erro de conectividade: " + err.message);
        addConnectionError("üí° Poss√≠veis solu√ß√µes:");
        addConnectionError("‚Ä¢ Reinicie o MetaMask");
        addConnectionError("‚Ä¢ Mude para BSC Testnet manualmente");
        addConnectionError("‚Ä¢ Verifique sua conex√£o com internet");
    }
}

// Eventos dos bot√µes
document.getElementById("checkContract").addEventListener("click", checkContract);
document.getElementById("testConnection").addEventListener("click", testConnection);
document.getElementById("buyButton").addEventListener("click", async () => {
    try {
        if (!signer) await connectWallet();
        await buyTokens();
    } catch (err) {
        addPurchaseError("Erro inesperado: " + err.message);
    }
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Template Loader -->
<script src="js/template-loader.js"></script>
</body>
</html>
