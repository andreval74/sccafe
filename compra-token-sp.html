<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra de Tokens Simples - SCCAFE</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #ff8c00;
        }
        h2 {
            color: #ff8c00;
            text-align: center;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            color: #ff8c00;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #1a1a1a;
            color: white;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #ff8c00;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #e67e00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            color: #ff4444;
            margin: 10px 0;
        }
        .success {
            color: #44ff44;
            margin: 10px 0;
        }
        .warning {
            color: #ffaa44;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ü™ô Compra de Tokens Simples</h2>

        <div class="info">
            <strong>Status da Carteira:</strong> <span id="walletStatus">N√£o conectado</span><br>
            <strong>Rede:</strong> <span id="networkStatus">‚Äî</span>
        </div>

        <label>Endere√ßo do Contrato de Venda:</label>
        <input type="text" id="saleAddress" placeholder="0x..." value="">

        <label>Quantidade de Tokens:</label>
        <input type="number" id="tokenAmount" min="1" step="1" value="10" oninput="calcularTotal()">

        <div class="info">
            <strong>Pre√ßo unit√°rio:</strong> <span id="precoToken">‚Äî</span> BNB<br>
            <strong>Total a pagar:</strong> <span id="totalBNB">‚Äî</span> BNB
        </div>

        <button onclick="connectWallet()">Conectar MetaMask</button>
        <button onclick="loadPrice()" disabled id="loadPriceBtn">Carregar Pre√ßo do Token</button>
        <button onclick="comprar()" disabled id="buyBtn">Comprar Tokens</button>

        <div id="messages"></div>
    </div>

    <script>
        let web3;
        let account;
        let saleContract;
        let tokenPrice = 0;
        let networkId;

        // ABI m√≠nima para contratos de venda
        const saleAbi = [
            {
                "constant": true,
                "inputs": [],
                "name": "tokenPrice",
                "outputs": [{"name": "", "type": "uint256"}],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [{"name": "amount", "type": "uint256"}],
                "name": "buyTokens",
                "outputs": [],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [],
                "name": "buy",
                "outputs": [],
                "type": "function"
            }
        ];

        function showMessage(message, type = 'info') {
            const messages = document.getElementById('messages');
            const className = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 
                             type === 'warning' ? 'warning' : 'info';
            messages.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Auto-clear after 10 seconds
            setTimeout(() => {
                messages.innerHTML = '';
            }, 10000);
        }

        function updateUI() {
            const connected = !!account;
            const contractLoaded = !!saleContract && tokenPrice > 0;
            
            document.getElementById('loadPriceBtn').disabled = !connected;
            document.getElementById('buyBtn').disabled = !connected || !contractLoaded;
        }

        // Adicionar ap√≥s a fun√ß√£o getNetworkName
        function isValidNetwork(networkId) {
            // Definir quais redes s√£o suportadas
            const supportedNetworks = [56, 97]; // BSC Mainnet e Testnet
            return supportedNetworks.includes(networkId);
        }
        
        // Modificar a fun√ß√£o connectWallet para incluir valida√ß√£o
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showMessage("MetaMask n√£o encontrada. Instale a extens√£o.", 'error');
                    return;
                }
        
                showMessage("Conectando √† MetaMask...", 'info');
                
                web3 = new Web3(window.ethereum);
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                
                // Obter informa√ß√µes da rede
                networkId = await web3.eth.net.getId();
                const networkName = getNetworkName(networkId);
                
                // Validar rede
                if (!isValidNetwork(networkId)) {
                    showMessage(`‚ö†Ô∏è Rede n√£o suportada: ${networkName}. Conecte-se √† BSC Mainnet (56) ou Testnet (97)`, 'warning');
                }
                
                document.getElementById('walletStatus').textContent = `${account.substring(0, 8)}...${account.substring(36)}`;
                document.getElementById('networkStatus').textContent = `${networkName} (${networkId})`;
                
                showMessage(`Carteira conectada: ${account.substring(0, 8)}...`, 'success');
                updateUI();
                
            } catch (error) {
                showMessage(`Erro ao conectar: ${error.message}`, 'error');
            }
        }

        function getNetworkName(id) {
            const networks = {
                1: 'Ethereum Mainnet',
                56: 'BSC Mainnet',
                97: 'BSC Testnet',
                137: 'Polygon Mainnet',
                80001: 'Polygon Testnet'
            };
            return networks[id] || `Rede ${id}`;
        }

        async function loadPrice() {
            if (!web3) {
                showMessage("Conecte sua carteira antes de carregar o pre√ßo!", 'warning');
                return;
            }

            try {
                const address = document.getElementById('saleAddress').value.trim();
                
                if (!address) {
                    showMessage("Digite o endere√ßo do contrato de venda!", 'warning');
                    return;
                }

                if (!web3.utils.isAddress(address)) {
                    showMessage("Endere√ßo inv√°lido!", 'error');
                    return;
                }

                showMessage("Carregando informa√ß√µes do contrato...", 'info');
                
                saleContract = new web3.eth.Contract(saleAbi, address);
                
                // Verificar se o contrato existe primeiro
                const code = await web3.eth.getCode(address);
                if (code === '0x') {
                    showMessage("‚ùå Nenhum contrato encontrado neste endere√ßo na rede atual!", 'error');
                    saleContract = null;
                    updateUI();
                    return;
                }
                
                // Tentar carregar o pre√ßo com timeout
                try {
                    const priceWei = await Promise.race([
                        saleContract.methods.tokenPrice().call(),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout: Opera√ß√£o demorou muito')), 10000)
                        )
                    ]);
                    
                    tokenPrice = web3.utils.fromWei(priceWei, 'ether');
                    
                    document.getElementById('precoToken').textContent = parseFloat(tokenPrice).toFixed(6);
                    calcularTotal();
                    
                    showMessage(`Pre√ßo carregado: ${parseFloat(tokenPrice).toFixed(6)} BNB por token`, 'success');
                    updateUI();
                    
                } catch (priceError) {
                    console.error('Erro detalhado:', priceError);
                    
                    if (priceError.message.includes('missing trie node') || 
                        priceError.message.includes('Internal JSON-RPC error') ||
                        priceError.message.includes('execution reverted')) {
                        showMessage("‚ö†Ô∏è Erro de rede ou contrato incompat√≠vel. Verifique:\n‚Ä¢ Se est√° na rede correta\n‚Ä¢ Se o endere√ßo est√° correto\n‚Ä¢ Se o contrato tem a fun√ß√£o tokenPrice()", 'error');
                    } else if (priceError.message.includes('Timeout')) {
                        showMessage("‚è±Ô∏è Opera√ß√£o demorou muito. Tente novamente.", 'error');
                    } else {
                        showMessage(`Erro ao carregar pre√ßo: ${priceError.message}`, 'error');
                    }
                    saleContract = null;
                    updateUI();
                }
                
            } catch (error) {
                console.error('Erro geral:', error);
                showMessage(`Erro: ${error.message}`, 'error');
                saleContract = null;
                updateUI();
            }
        }

        function calcularTotal() {
            const qtd = parseFloat(document.getElementById('tokenAmount').value) || 0;
            const total = qtd * parseFloat(tokenPrice || 0);
            document.getElementById('totalBNB').textContent = isNaN(total) ? '‚Äî' : total.toFixed(6);
        }

        async function comprar() {
            try {
                if (!saleContract) {
                    showMessage("Carregue o contrato primeiro!", 'warning');
                    return;
                }

                const qtd = parseInt(document.getElementById('tokenAmount').value);
                if (!qtd || qtd <= 0) {
                    showMessage("Digite uma quantidade v√°lida!", 'warning');
                    return;
                }

                const totalBNB = (qtd * tokenPrice).toString();
                const totalWei = web3.utils.toWei(totalBNB, 'ether');

                showMessage(`Enviando transa√ß√£o para comprar ${qtd} tokens...`, 'info');

                // Tentar m√©todo buyTokens primeiro, depois buy
                let method;
                try {
                    method = saleContract.methods.buyTokens(qtd);
                } catch (e) {
                    method = saleContract.methods.buy();
                }

                await method.send({
                    from: account,
                    value: totalWei
                })
                .on('transactionHash', hash => {
                    showMessage(`Transa√ß√£o enviada! Hash: ${hash}`, 'info');
                })
                .on('receipt', receipt => {
                    showMessage("üéâ Compra conclu√≠da com sucesso!", 'success');
                })
                .on('error', err => {
                    showMessage(`Erro na transa√ß√£o: ${err.message}`, 'error');
                });

            } catch (error) {
                showMessage(`Erro ao comprar: ${error.message}`, 'error');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            updateUI();
            showMessage("Conecte sua carteira para come√ßar", 'info');
        });
    </script>
</body>
</html>
